// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: QBands - Adaptive Price Bands", shorttitle="QBands", overlay=true, max_labels_count=500)

// ============================================================================
// QBANDS v2 â€” ADAPTIVE VOLATILITY BANDS WITH SQUEEZE DETECTION
// ============================================================================
// Bollinger Bands + Keltner Channels working together. The key feature is
// SQUEEZE DETECTION: when BB contracts inside KC, volatility is coiling up
// for an explosive move. This is the TTM Squeeze concept.
//
// Multi-level bands (1Ïƒ, 2Ïƒ, 3Ïƒ) provide graduated overbought/oversold zones.
// Band touch quality scoring identifies high-probability reversal signals.
//
// v2 ENHANCEMENTS over v1:
//   1. Auto-optimized band parameters per symbol/timeframe
//   2. Keltner Channel overlay for squeeze confirmation (BB inside KC = squeeze)
//   3. Multi-level bands (1Ïƒ, 2Ïƒ, 3Ïƒ) for graduated zone mapping
//   4. Band touch quality scoring (wick-only vs body penetration vs close beyond)
//   5. Squeeze duration tracking and fire direction detection
//   6. Bandwidth tracking (volatility expansion/contraction)
//   7. Price position within bands (0-1 normalized)
//   8. Info table with all real-time metrics
//   9. Enhanced webhook payload
//  10. Hidden plot exports for Master Confluence
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe.")

// Manual override inputs
int manual_bb_length = input.int(20, "BB Length", minval=10, maxval=50, group="ðŸ”§ Manual Settings")
float manual_bb_mult = input.float(2.0, "BB Multiplier", minval=1.0, maxval=4.0, step=0.1, group="ðŸ”§ Manual Settings")
float manual_kc_mult = input.float(1.5, "KC Multiplier (ATR)", minval=0.5, maxval=3.0, step=0.1, group="ðŸ”§ Manual Settings")

// Visual settings
bool show_1sigma = input.bool(true, "Show 1Ïƒ Bands (Inner)", group="ðŸŽ¨ Visuals")
bool show_2sigma = input.bool(true, "Show 2Ïƒ Bands (Standard)", group="ðŸŽ¨ Visuals")
bool show_3sigma = input.bool(false, "Show 3Ïƒ Bands (Outer)", group="ðŸŽ¨ Visuals")
bool show_kc = input.bool(false, "Show Keltner Channels", group="ðŸŽ¨ Visuals", tooltip="Shows the KC bands used for squeeze detection")
bool show_squeeze_bg = input.bool(true, "Show Squeeze Background", group="ðŸŽ¨ Visuals")
bool show_touch_labels = input.bool(true, "Show Band Touch Labels", group="ðŸŽ¨ Visuals")
bool show_squeeze_labels = input.bool(true, "Show Squeeze Labels", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts")
bool alert_on_squeeze = input.bool(true, "Alert on Squeeze Fire", group="ðŸ”” Alerts")
bool alert_on_touch = input.bool(true, "Alert on Band Touch (2Ïƒ+)", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py â€” REAL optimized values from backtesting
// Placeholder values will be replaced after running: python -m scripts.optimize_params --indicator qbands

f_auto_bb_length() =>
    string t = syminfo.ticker
    if t == "SPY" or t == "QQQ"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 22
    else if t == "TSLA" or t == "NVDA"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 20 : 22
    else if t == "META" or t == "NFLX"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 20 : 22
    else if t == "AAPL" or t == "GOOGL" or t == "MSFT" or t == "AMZN" or t == "AMD"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 22
    else
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 22

f_auto_bb_mult() =>
    string t = syminfo.ticker
    if t == "TSLA" or t == "NVDA"
        tf_group == "scalp" ? 2.0 : tf_group == "intraday" ? 2.0 : 2.2
    else if t == "SPY" or t == "QQQ"
        tf_group == "scalp" ? 2.0 : tf_group == "intraday" ? 2.0 : 2.0
    else
        tf_group == "scalp" ? 2.0 : tf_group == "intraday" ? 2.0 : 2.0

f_auto_kc_mult() =>
    string t = syminfo.ticker
    if t == "TSLA" or t == "NVDA"
        tf_group == "scalp" ? 1.5 : tf_group == "intraday" ? 1.5 : 1.5
    else
        tf_group == "scalp" ? 1.5 : tf_group == "intraday" ? 1.5 : 1.5

// Apply settings
int bb_length = settings_mode == "Auto" ? f_auto_bb_length() : manual_bb_length
float bb_mult = settings_mode == "Auto" ? f_auto_bb_mult() : manual_bb_mult
float kc_mult = settings_mode == "Auto" ? f_auto_kc_mult() : manual_kc_mult

// ==================== CORE CALCULATIONS ====================

// --- Shared basis: EMA (faster than SMA for scalping) ---
float basis = ta.ema(close, bb_length)

// --- Bollinger Bands (3 levels) ---
float stdev = ta.stdev(close, bb_length)
float bb1_upper = basis + 1.0 * stdev          // 1Ïƒ
float bb1_lower = basis - 1.0 * stdev
float bb2_upper = basis + bb_mult * stdev       // 2Ïƒ (standard)
float bb2_lower = basis - bb_mult * stdev
float bb3_upper = basis + 3.0 * stdev           // 3Ïƒ (extreme)
float bb3_lower = basis - 3.0 * stdev

// --- Keltner Channels (for squeeze detection) ---
float atr_val = ta.atr(bb_length)
float kc_upper = basis + kc_mult * atr_val
float kc_lower = basis - kc_mult * atr_val

// ==================== SQUEEZE DETECTION ====================
// Squeeze ON = BB is INSIDE KC (volatility compressed)
// Squeeze OFF = BB is OUTSIDE KC (normal or expanding)
bool squeeze_on = bb2_upper < kc_upper and bb2_lower > kc_lower
bool squeeze_off = not squeeze_on

// Squeeze state transitions
bool squeeze_started = squeeze_on and not squeeze_on[1]
bool squeeze_fired = squeeze_off and squeeze_on[1]

// Squeeze fire direction: which way did price break?
// Use momentum (close vs basis) at the moment squeeze fires
float squeeze_momentum = close - basis
string squeeze_fire_dir = squeeze_fired ? (squeeze_momentum > 0 ? "BULLISH" : "BEARISH") : ""

// Squeeze duration tracking
var int squeeze_bars = 0
if squeeze_on
    squeeze_bars += 1
else
    squeeze_bars := 0

// Track last squeeze fire direction for info table
var string last_squeeze_dir = "NONE"
if squeeze_fired
    last_squeeze_dir := squeeze_momentum > 0 ? "BULL" : "BEAR"

// ==================== BANDWIDTH & POSITION ====================
// Bandwidth: BB width as % of price (measure of volatility)
float bandwidth = (bb2_upper - bb2_lower) / basis * 100.0

// Bandwidth dynamics
float bw_sma = ta.sma(bandwidth, 20)
string bw_state = bandwidth > bw_sma * 1.1 ? "EXPANDING" : bandwidth < bw_sma * 0.9 ? "CONTRACTING" : "NORMAL"

// Price position within bands (0 = at lower, 0.5 = at basis, 1 = at upper)
float band_range = bb2_upper - bb2_lower
float band_position = band_range > 0 ? (close - bb2_lower) / band_range : 0.5

// ==================== BAND TOUCH DETECTION ====================
// Touch quality scoring for 2Ïƒ bands
// 3 = Wick-only touch (best reversal signal)
// 2 = Body penetration (moderate)
// 1 = Close beyond band (band failed)

// Upper band touch detection
bool wick_touch_upper = high >= bb2_upper and close < bb2_upper and open < bb2_upper
bool body_touch_upper = (close >= bb2_upper or open >= bb2_upper) and close < bb3_upper
bool close_beyond_upper = close >= bb2_upper

// Lower band touch detection
bool wick_touch_lower = low <= bb2_lower and close > bb2_lower and open > bb2_lower
bool body_touch_lower = (close <= bb2_lower or open <= bb2_lower) and close > bb3_lower
bool close_beyond_lower = close <= bb2_lower

// Touch quality score
int upper_touch_score = wick_touch_upper ? 3 : body_touch_upper ? 2 : close_beyond_upper ? 1 : 0
int lower_touch_score = wick_touch_lower ? 3 : body_touch_lower ? 2 : close_beyond_lower ? 1 : 0

bool any_upper_touch = upper_touch_score > 0
bool any_lower_touch = lower_touch_score > 0

// 3Ïƒ extreme touches
bool touch_3sigma_upper = high >= bb3_upper
bool touch_3sigma_lower = low <= bb3_lower

// Touch at 3Ïƒ minimum gap (prevent double counting)
var int bars_since_upper_touch = 100
var int bars_since_lower_touch = 100
if any_upper_touch
    bars_since_upper_touch := 0
else
    bars_since_upper_touch += 1
if any_lower_touch
    bars_since_lower_touch := 0
else
    bars_since_lower_touch += 1

bool valid_upper_touch = any_upper_touch and bars_since_upper_touch[1] >= 3
bool valid_lower_touch = any_lower_touch and bars_since_lower_touch[1] >= 3

// ==================== MEAN REVERSION DETECTION ====================
// Price returning to basis after touching band
bool returning_from_upper = close[1] > bb2_upper[1] and close <= basis
bool returning_from_lower = close[1] < bb2_lower[1] and close >= basis

// ==================== VISUAL RENDERING ====================

// --- Basis line ---
plot(basis, "Basis (EMA)", color=color.new(#FFFFFF, 30), linewidth=1)

// --- 1Ïƒ bands (inner) ---
p_1u = plot(show_1sigma ? bb1_upper : na, "1Ïƒ Upper", color=color.new(#4CAF50, 70), linewidth=1)
p_1l = plot(show_1sigma ? bb1_lower : na, "1Ïƒ Lower", color=color.new(#F44336, 70), linewidth=1)
fill(p_1u, p_1l, color=show_1sigma ? color.new(#9E9E9E, 92) : na, title="1Ïƒ Fill")

// --- 2Ïƒ bands (standard) ---
p_2u = plot(show_2sigma ? bb2_upper : na, "2Ïƒ Upper", color=color.new(#4CAF50, 40), linewidth=2)
p_2l = plot(show_2sigma ? bb2_lower : na, "2Ïƒ Lower", color=color.new(#F44336, 40), linewidth=2)
fill(p_2u, p_2l, color=show_2sigma ? color.new(#2196F3, 93) : na, title="2Ïƒ Fill")

// --- 3Ïƒ bands (outer / extreme) ---
p_3u = plot(show_3sigma ? bb3_upper : na, "3Ïƒ Upper", color=color.new(#FF9800, 60), linewidth=1, style=plot.style_linebr)
p_3l = plot(show_3sigma ? bb3_lower : na, "3Ïƒ Lower", color=color.new(#FF9800, 60), linewidth=1, style=plot.style_linebr)

// --- Keltner Channels (optional, for squeeze visualization) ---
plot(show_kc ? kc_upper : na, "KC Upper", color=color.new(#E040FB, 50), linewidth=1, style=plot.style_circles)
plot(show_kc ? kc_lower : na, "KC Lower", color=color.new(#E040FB, 50), linewidth=1, style=plot.style_circles)

// --- Squeeze background ---
bgcolor(show_squeeze_bg and squeeze_on ? color.new(#FF9800, 88) : na, title="Squeeze Background")

// --- Squeeze labels ---
if show_squeeze_labels and squeeze_started
    label.new(bar_index, high, "â—† SQZ ON", style=label.style_label_down, color=color.new(color.orange, 20), textcolor=color.white, size=size.tiny)

if show_squeeze_labels and squeeze_fired
    color fire_color = squeeze_momentum > 0 ? color.green : color.red
    string fire_text = squeeze_momentum > 0 ? "â—† FIRE â–²" : "â—† FIRE â–¼"
    label.new(bar_index, squeeze_momentum > 0 ? low : high, fire_text, style=squeeze_momentum > 0 ? label.style_label_up : label.style_label_down, color=fire_color, textcolor=color.white, size=size.small)

// --- Band touch labels ---
if show_touch_labels and valid_upper_touch
    string touch_text = upper_touch_score == 3 ? "â–¼ â˜…â˜…â˜…" : upper_touch_score == 2 ? "â–¼ â˜…â˜…" : "â–¼ â˜…"
    color touch_color = upper_touch_score == 3 ? color.new(#FF5722, 0) : upper_touch_score == 2 ? color.new(#FF9800, 0) : color.new(#FFC107, 0)
    label.new(bar_index, high, touch_text, style=label.style_label_down, color=touch_color, textcolor=color.white, size=size.tiny)

if show_touch_labels and valid_lower_touch
    string touch_text = lower_touch_score == 3 ? "â–² â˜…â˜…â˜…" : lower_touch_score == 2 ? "â–² â˜…â˜…" : "â–² â˜…"
    color touch_color = lower_touch_score == 3 ? color.new(#4CAF50, 0) : lower_touch_score == 2 ? color.new(#8BC34A, 0) : color.new(#CDDC39, 0)
    label.new(bar_index, low, touch_text, style=label.style_label_up, color=touch_color, textcolor=color.white, size=size.tiny)

// --- 3Ïƒ extreme touch labels ---
if show_touch_labels and touch_3sigma_upper
    label.new(bar_index, high, "3Ïƒ!", style=label.style_label_down, color=color.new(#FF5722, 0), textcolor=color.white, size=size.tiny)
if show_touch_labels and touch_3sigma_lower
    label.new(bar_index, low, "3Ïƒ!", style=label.style_label_up, color=color.new(#4CAF50, 0), textcolor=color.white, size=size.tiny)

// ==================== INFO TABLE ====================
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 9, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Name
    table.cell(info_table, 0, 0, "QBands v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: Squeeze state
    table.cell(info_table, 0, 1, "Squeeze", text_color=color.gray, text_size=size.tiny)
    string sqz_text = squeeze_on ? "â—† ON (" + str.tostring(squeeze_bars) + " bars)" : "OFF"
    color sqz_color = squeeze_on ? color.orange : color.gray
    table.cell(info_table, 1, 1, sqz_text, text_color=sqz_color, text_size=size.small)

    // Row 2: Last squeeze fire
    table.cell(info_table, 0, 2, "Last Fire", text_color=color.gray, text_size=size.tiny)
    color fire_clr = last_squeeze_dir == "BULL" ? color.green : last_squeeze_dir == "BEAR" ? color.red : color.gray
    table.cell(info_table, 1, 2, last_squeeze_dir, text_color=fire_clr, text_size=size.small)

    // Row 3: Bandwidth
    table.cell(info_table, 0, 3, "BW %", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 3, str.tostring(bandwidth, "#.##") + "%", text_color=color.white, text_size=size.small)

    // Row 4: BW state
    table.cell(info_table, 0, 4, "Volatility", text_color=color.gray, text_size=size.tiny)
    color bw_color = bw_state == "EXPANDING" ? color.green : bw_state == "CONTRACTING" ? color.orange : color.gray
    table.cell(info_table, 1, 4, bw_state, text_color=bw_color, text_size=size.small)

    // Row 5: Band position
    table.cell(info_table, 0, 5, "Position", text_color=color.gray, text_size=size.tiny)
    string pos_text = band_position >= 0.8 ? "UPPER" : band_position >= 0.6 ? "HIGH" : band_position >= 0.4 ? "MID" : band_position >= 0.2 ? "LOW" : "LOWER"
    color pos_color = band_position >= 0.8 ? color.red : band_position >= 0.6 ? color.orange : band_position >= 0.4 ? color.white : band_position >= 0.2 ? color.teal : color.green
    table.cell(info_table, 1, 5, pos_text + " (" + str.tostring(band_position, "#.##") + ")", text_color=pos_color, text_size=size.small)

    // Row 6: Basis distance
    table.cell(info_table, 0, 6, "From Basis", text_color=color.gray, text_size=size.tiny)
    float basis_dist = (close - basis) / basis * 100
    color bd_color = basis_dist > 0 ? color.green : color.red
    table.cell(info_table, 1, 6, str.tostring(basis_dist, "#.##") + "%", text_color=bd_color, text_size=size.small)

    // Row 7: Settings
    table.cell(info_table, 0, 7, "Settings", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, settings_mode == "Auto" ? "Auto" : "Manual", text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 8: Params
    table.cell(info_table, 0, 8, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 8, "BB:" + str.tostring(bb_length) + " Ïƒ:" + str.tostring(bb_mult, "#.#") + " KC:" + str.tostring(kc_mult, "#.#"), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
plot(squeeze_on ? 1 : 0, "X_QBandsSqueeze", display=display.none)
plot(squeeze_bars, "X_QBandsSqueezeBars", display=display.none)
plot(bandwidth, "X_QBandsBandwidth", display=display.none)
plot(band_position, "X_QBandsPosition", display=display.none)
plot(valid_upper_touch ? upper_touch_score : valid_lower_touch ? -lower_touch_score : 0, "X_QBandsTouch", display=display.none)
plot(squeeze_fired ? (squeeze_momentum > 0 ? 1 : -1) : 0, "X_QBandsFire", display=display.none)
plot(basis, "X_QBandsBasis", display=display.none)
plot(bb2_upper, "X_QBandsUpper", display=display.none)
plot(bb2_lower, "X_QBandsLower", display=display.none)

// ==================== ALERTS ====================
alertcondition(squeeze_started, "QBands: Squeeze Started", "QBands squeeze detected â€” volatility compressing, big move loading")
alertcondition(squeeze_fired, "QBands: Squeeze Fired", "QBands squeeze released â€” breakout in progress")
alertcondition(squeeze_fired and squeeze_momentum > 0, "QBands: Squeeze Fire Bullish", "QBands squeeze fired BULLISH â€” price breaking up")
alertcondition(squeeze_fired and squeeze_momentum <= 0, "QBands: Squeeze Fire Bearish", "QBands squeeze fired BEARISH â€” price breaking down")
alertcondition(valid_upper_touch and upper_touch_score >= 2, "QBands: Upper Band Touch (â˜…â˜…+)", "Price touching upper 2Ïƒ band â€” potential overbought reversal")
alertcondition(valid_lower_touch and lower_touch_score >= 2, "QBands: Lower Band Touch (â˜…â˜…+)", "Price touching lower 2Ïƒ band â€” potential oversold reversal")
alertcondition(touch_3sigma_upper, "QBands: 3Ïƒ Upper Extreme", "Price hit 3Ïƒ upper band â€” extreme overbought")
alertcondition(touch_3sigma_lower, "QBands: 3Ïƒ Lower Extreme", "Price hit 3Ïƒ lower band â€” extreme oversold")

// ==================== WEBHOOK ALERT ====================
bool any_alert = (alert_on_squeeze and (squeeze_started or squeeze_fired)) or (alert_on_touch and ((valid_upper_touch and upper_touch_score >= 2) or (valid_lower_touch and lower_touch_score >= 2)))

if any_alert
    string alert_type = squeeze_fired ? (squeeze_momentum > 0 ? "squeeze_fire_bull" : "squeeze_fire_bear") : squeeze_started ? "squeeze_start" : valid_upper_touch ? "touch_upper" : valid_lower_touch ? "touch_lower" : "unknown"
    int touch_score = valid_upper_touch ? upper_touch_score : valid_lower_touch ? lower_touch_score : 0
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"qbands","alert_type":"' + alert_type + '","squeeze_on":' + str.tostring(squeeze_on) + ',"squeeze_bars":' + str.tostring(squeeze_bars) + ',"bandwidth":' + str.tostring(bandwidth, "#.##") + ',"band_position":' + str.tostring(band_position, "#.##") + ',"bw_state":"' + bw_state + '","touch_score":' + str.tostring(touch_score) + ',"basis":' + str.tostring(basis, "#.##") + ',"bb_upper":' + str.tostring(bb2_upper, "#.##") + ',"bb_lower":' + str.tostring(bb2_lower, "#.##") + ',"price":' + str.tostring(close, "#.##") + ',"settings_mode":"' + settings_mode + '","bb_length":' + str.tostring(bb_length) + ',"bb_mult":' + str.tostring(bb_mult, "#.#") + ',"kc_mult":' + str.tostring(kc_mult, "#.#") + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
