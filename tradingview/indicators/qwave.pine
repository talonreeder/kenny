// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: QWave - Bull/Bear Momentum", shorttitle="QWave", overlay=false, precision=1, max_labels_count=500)

// ============================================================================
// QWAVE v2 â€” ADX-BASED DIRECTIONAL MOVEMENT SYSTEM
// ============================================================================
// Measures whether bulls or bears are in control and how strongly.
// Outputs a continuous score from -100 (max bearish) to +100 (max bullish).
//
// CORE INNOVATION: ADX-weighted power curve suppresses noise during weak/choppy
// markets and amplifies signals during real trending moves. This prevents
// false entries during ranging conditions â€” where most scalp losses occur.
//
// Formula: direction Ã— pow(adx_norm, 1.5) Ã— 100
//   direction = (DI+ - DI-) / (DI+ + DI-)     â†’ who's winning (-1 to +1)
//   adx_norm  = min(ADX / 50, 1.0)             â†’ trend strength (0 to 1)
//   amplifier = pow(adx_norm, 1.5)              â†’ exponential suppression
//
// ADX = 12 â†’ only 9% of signal passes through  â†’ "no real trend, skip"
// ADX = 35 â†’ 47% of signal passes through       â†’ "real move, pay attention"
// ADX = 50 â†’ 100% of signal passes through      â†’ "full trend, act on it"
//
// v2 ENHANCEMENTS over v1:
//   1. Complete redesign: Bollinger breakout â†’ ADX/DI+/DI- directional movement
//   2. Continuous -100 to +100 score (was binary breakout signals)
//   3. ADX power curve trend filter (was no trend filter)
//   4. 6-zone classification system with visual zone coloring
//   5. Auto-optimized settings per symbol/timeframe (lookup tables)
//   6. Zero-line flips, zone crossings, divergence detection, slope analysis
//   7. Info table with all real-time metrics
//   8. Enhanced webhook payload with full analytics
//   9. Hidden plot exports for Master Confluence
//  10. alertcondition() entries for TradingView alerts
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
// Detects current symbol and timeframe, selects optimal parameters automatically.
// TradingView settings are GLOBAL (not per-chart), so this solves the problem
// of needing different settings for SPY vs TSLA vs different timeframes.

// Determine timeframe group
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode: Auto (recommended) or Manual override
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe. Manual = use your custom values below.")

// Manual override inputs (only used when settings_mode == "Manual")
int manual_adx_length = input.int(14, "ADX Length", minval=5, maxval=50, group="ðŸ”§ Manual Settings", tooltip="Lookback period for ADX/DI+/DI- calculations")
int manual_smoothing = input.int(2, "QWave Smoothing", minval=1, maxval=10, group="ðŸ”§ Manual Settings", tooltip="EMA smoothing on QWave score (1 = no smoothing)")

// Visual settings
bool show_flip_labels = input.bool(true, "Show Zero-Line Flip Labels", group="ðŸŽ¨ Visuals")
bool show_zone_labels = input.bool(true, "Show Zone Entry Labels", group="ðŸŽ¨ Visuals")
bool show_adx_line = input.bool(false, "Show Raw ADX Line", group="ðŸŽ¨ Visuals", tooltip="Shows the raw ADX trend strength line (0-50 scale)")
bool show_di_lines = input.bool(false, "Show DI+/DI- Lines", group="ðŸŽ¨ Visuals", tooltip="Shows the raw Directional Indicator lines")
bool show_zone_fill = input.bool(true, "Show Zone Background Fill", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts", tooltip="Secret key for webhook authentication")
bool alert_on_flip = input.bool(true, "Alert on Zero-Line Flip", group="ðŸ”” Alerts")
bool alert_on_zone = input.bool(true, "Alert on Zone Entry (Bull/Bear)", group="ðŸ”” Alerts")
bool alert_on_trend = input.bool(false, "Alert on ADX Trend Emerging", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py on 2026-02-13 22:07:42
// These values are REAL optimized results from backtesting against historical data.
// DO NOT manually edit â€” re-run the optimizer to update.

f_auto_adx_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "QQQ"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "TSLA"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "NVDA"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "META"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 22
    else if t == "NFLX"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "AAPL"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "GOOGL"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "MSFT"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "AMZN"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 22
    else if t == "AMD"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25

f_auto_smoothing() =>
    string t = syminfo.ticker
    if t == "GOOGL"
        tf_group == "scalp" ? 5 : tf_group == "intraday" ? 5 : 4
    else
        5

// Apply settings based on mode
int adx_length = settings_mode == "Auto" ? f_auto_adx_length() : manual_adx_length
int smooth_len = settings_mode == "Auto" ? f_auto_smoothing() : manual_smoothing

// ==================== CORE CALCULATION ====================
// Step 1: Get DMI components (DI+, DI-, ADX)
// ta.dmi(di_length, adx_smoothing) returns [plus, minus, adx]
[di_plus, di_minus, adx_val] = ta.dmi(adx_length, adx_length)

// Step 2: Direction â€” who's winning? Normalized to -1 to +1
// Guard against division by zero when both DI values are near 0
float di_sum = di_plus + di_minus
float direction = di_sum > 0.001 ? (di_plus - di_minus) / di_sum : 0.0

// Step 3: Trend strength â€” how real is the move? Normalized to 0 to 1
float adx_norm = math.min(adx_val / 50.0, 1.0)

// Step 4: Power curve â€” crush weak signals, amplify strong
// ADX=10 â†’ 9% passed, ADX=25 â†’ 35% passed, ADX=40 â†’ 72% passed, ADX=50+ â†’ 100%
float amplifier = math.pow(adx_norm, 1.5)

// Step 5: Combine into QWave score (-100 to +100)
float qwave_raw = direction * amplifier * 100.0

// Step 6: Optional EMA smoothing (1 = no smoothing)
float qwave = smooth_len == 1 ? qwave_raw : ta.ema(qwave_raw, smooth_len)

// ==================== ZONE CLASSIFICATION ====================
// 6 zones: Strong Bear â†’ Strong Bull
int zone = qwave >= 60 ? 6 : qwave >= 30 ? 5 : qwave >= 0 ? 4 : qwave >= -30 ? 3 : qwave >= -60 ? 2 : 1

string zone_name = switch zone
    6 => "STRONG BULL"
    5 => "BULL"
    4 => "WEAK BULL"
    3 => "WEAK BEAR"
    2 => "BEAR"
    1 => "STRONG BEAR"
    => "UNKNOWN"

color zone_color = switch zone
    6 => color.new(#00FF00, 0)
    5 => color.new(#00CC00, 0)
    4 => color.new(#006600, 0)
    3 => color.new(#660000, 0)
    2 => color.new(#CC0000, 0)
    1 => color.new(#FF0000, 0)
    => color.gray

// Previous zone for crossing detection
int prev_zone = nz(zone[1], 4)

// ==================== SIGNAL DETECTION ====================

// --- Zero-line flips (primary signal) ---
bool bullish_flip = ta.crossover(qwave, 0)
bool bearish_flip = ta.crossunder(qwave, 0)

// --- Zone crossings ---
bool zone_changed = zone != prev_zone
bool entered_strong_bull = zone == 6 and prev_zone < 6
bool entered_bull = zone >= 5 and prev_zone < 5
bool entered_bear = zone <= 2 and prev_zone > 2
bool entered_strong_bear = zone == 1 and prev_zone > 1

// --- Zone strengthening / weakening ---
bool strengthening = (zone > 3 and zone > prev_zone) or (zone <= 3 and zone < prev_zone)
bool weakening = (zone > 3 and zone < prev_zone) or (zone <= 3 and zone > prev_zone)

// --- ADX threshold events ---
bool trend_emerging = ta.crossover(adx_val, 20)
bool trend_dying = ta.crossunder(adx_val, 20)

// --- ADX strength classification ---
string adx_state = adx_val >= 40 ? "STRONG" : adx_val >= 25 ? "MODERATE" : adx_val >= 20 ? "EMERGING" : "WEAK"

// --- QWave slope (rate of change over 3 bars) ---
float qwave_slope = qwave - nz(qwave[3], qwave)
string slope_state = math.abs(qwave_slope) < 2.0 ? "FLAT" : (qwave > 0 and qwave_slope > 0) or (qwave < 0 and qwave_slope < 0) ? "ACCEL" : "DECEL"

// --- Bars in current zone ---
var int bars_in_zone = 0
if zone_changed
    bars_in_zone := 1
else
    bars_in_zone += 1

// --- Bars since last zero-line flip ---
var int bars_since_flip = 0
if bullish_flip or bearish_flip
    bars_since_flip := 0
else
    bars_since_flip += 1

// --- Track last flip direction ---
var string last_flip_dir = "none"
if bullish_flip
    last_flip_dir := "bullish"
if bearish_flip
    last_flip_dir := "bearish"

// ==================== DIVERGENCE DETECTION ====================
// Bearish divergence: price higher high + QWave lower high
// Bullish divergence: price lower low + QWave higher low

// Swing high/low detection (5-bar pivot)
int pivot_len = 5
float ph = ta.pivothigh(high, pivot_len, pivot_len)
float pl = ta.pivotlow(low, pivot_len, pivot_len)
float qph = ta.pivothigh(qwave, pivot_len, pivot_len)
float qpl = ta.pivotlow(qwave, pivot_len, pivot_len)

// Track last two pivot highs/lows for price and QWave
var float prev_price_high = na
var float curr_price_high = na
var float prev_qwave_high = na
var float curr_qwave_high = na
var float prev_price_low = na
var float curr_price_low = na
var float prev_qwave_low = na
var float curr_qwave_low = na

if not na(ph)
    prev_price_high := curr_price_high
    curr_price_high := ph
if not na(qph)
    prev_qwave_high := curr_qwave_high
    curr_qwave_high := qph
if not na(pl)
    prev_price_low := curr_price_low
    curr_price_low := pl
if not na(qpl)
    prev_qwave_low := curr_qwave_low
    curr_qwave_low := qpl

// Detect divergence (only when we have two valid pivots to compare)
bool bearish_divergence = not na(prev_price_high) and not na(curr_price_high) and not na(prev_qwave_high) and not na(curr_qwave_high) and curr_price_high > prev_price_high and curr_qwave_high < prev_qwave_high and not na(ph)
bool bullish_divergence = not na(prev_price_low) and not na(curr_price_low) and not na(prev_qwave_low) and not na(curr_qwave_low) and curr_price_low < prev_price_low and curr_qwave_low > prev_qwave_low and not na(pl)

// ==================== VISUAL RENDERING ====================

// --- Main QWave line with zone-based coloring ---
plot(qwave, "QWave", color=zone_color, linewidth=2)

// --- Zero line ---
hline(0, "Zero Line", color=color.new(#FFFFFF, 50), linestyle=hline.style_solid, linewidth=1)

// --- Zone boundaries ---
hline(60, "+60 Strong Bull", color=color.new(#00FF00, 80), linestyle=hline.style_dotted)
hline(30, "+30 Bull", color=color.new(#00CC00, 80), linestyle=hline.style_dotted)
hline(-30, "-30 Bear", color=color.new(#CC0000, 80), linestyle=hline.style_dotted)
hline(-60, "-60 Strong Bear", color=color.new(#FF0000, 80), linestyle=hline.style_dotted)

// --- Zone background fill ---
bgcolor(show_zone_fill and qwave >= 60 ? color.new(#00FF00, 90) : show_zone_fill and qwave >= 30 ? color.new(#00CC00, 93) : show_zone_fill and qwave <= -60 ? color.new(#FF0000, 90) : show_zone_fill and qwave <= -30 ? color.new(#CC0000, 93) : na, title="Zone Fill")

// --- Optional raw ADX line (scaled to fit pane: 0-50 range) ---
plot(show_adx_line ? adx_val : na, "ADX", color=color.new(color.yellow, 30), linewidth=1, style=plot.style_line)

// --- Optional DI+/DI- lines ---
plot(show_di_lines ? di_plus : na, "DI+", color=color.new(color.green, 50), linewidth=1)
plot(show_di_lines ? di_minus : na, "DI-", color=color.new(color.red, 50), linewidth=1)

// --- Zero-line flip labels ---
if show_flip_labels and bullish_flip
    label.new(bar_index, qwave, "âš¡ BULL", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)
if show_flip_labels and bearish_flip
    label.new(bar_index, qwave, "âš¡ BEAR", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// --- Zone entry labels ---
if show_zone_labels and entered_strong_bull
    label.new(bar_index, qwave, "ðŸ”¥ S.BULL", style=label.style_label_up, color=color.lime, textcolor=color.black, size=size.tiny)
if show_zone_labels and entered_strong_bear
    label.new(bar_index, qwave, "ðŸ”¥ S.BEAR", style=label.style_label_down, color=color.maroon, textcolor=color.white, size=size.tiny)

// --- Divergence labels ---
if bearish_divergence
    label.new(bar_index - pivot_len, qwave[pivot_len], "DIV â–¼", style=label.style_label_down, color=color.new(color.orange, 20), textcolor=color.white, size=size.tiny)
if bullish_divergence
    label.new(bar_index - pivot_len, qwave[pivot_len], "DIV â–²", style=label.style_label_up, color=color.new(color.teal, 20), textcolor=color.white, size=size.tiny)

// --- ADX trend emerging label ---
if trend_emerging
    label.new(bar_index, 0, "ADXâ†‘", style=label.style_label_center, color=color.new(color.yellow, 20), textcolor=color.black, size=size.tiny)

// ==================== INFO TABLE ====================
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 9, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Indicator name
    table.cell(info_table, 0, 0, "QWave v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: QWave score
    table.cell(info_table, 0, 1, "Score", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 1, str.tostring(qwave, "#.#"), text_color=zone_color, text_size=size.small)

    // Row 2: Zone
    table.cell(info_table, 0, 2, "Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 2, zone_name, text_color=zone_color, text_size=size.small)

    // Row 3: ADX value + state
    table.cell(info_table, 0, 3, "ADX", text_color=color.gray, text_size=size.tiny)
    color adx_color = adx_val >= 40 ? color.lime : adx_val >= 25 ? color.green : adx_val >= 20 ? color.yellow : color.gray
    table.cell(info_table, 1, 3, str.tostring(adx_val, "#.#") + " " + adx_state, text_color=adx_color, text_size=size.small)

    // Row 4: DI+ vs DI-
    table.cell(info_table, 0, 4, "DI+/DI-", text_color=color.gray, text_size=size.tiny)
    color di_color = di_plus > di_minus ? color.green : color.red
    table.cell(info_table, 1, 4, str.tostring(di_plus, "#.#") + " / " + str.tostring(di_minus, "#.#"), text_color=di_color, text_size=size.small)

    // Row 5: Slope
    table.cell(info_table, 0, 5, "Slope", text_color=color.gray, text_size=size.tiny)
    color slope_color = slope_state == "ACCEL" ? color.lime : slope_state == "DECEL" ? color.orange : color.gray
    table.cell(info_table, 1, 5, slope_state, text_color=slope_color, text_size=size.small)

    // Row 6: Bars in zone
    table.cell(info_table, 0, 6, "In Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 6, str.tostring(bars_in_zone) + " bars", text_color=color.white, text_size=size.small)

    // Row 7: Settings mode
    table.cell(info_table, 0, 7, "Settings", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, settings_mode == "Auto" ? "Auto" : "Manual", text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 8: Active params
    table.cell(info_table, 0, 8, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 8, "ADX:" + str.tostring(adx_length) + " Sm:" + str.tostring(smooth_len), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
// For Master Confluence to read via source()
plot(qwave, "X_QWaveScore", display=display.none)
plot(zone, "X_QWaveZone", display=display.none)
plot(adx_val, "X_QWaveADX", display=display.none)
plot(qwave_slope, "X_QWaveSlope", display=display.none)
plot(di_plus, "X_QWaveDIPlus", display=display.none)
plot(di_minus, "X_QWaveDIMinus", display=display.none)
plot(bullish_flip ? 1 : bearish_flip ? -1 : 0, "X_QWaveFlip", display=display.none)
plot(bearish_divergence ? -1 : bullish_divergence ? 1 : 0, "X_QWaveDivergence", display=display.none)

// ==================== ALERTS ====================
// Standard TradingView alertcondition (const string messages â€” no series allowed)
alertcondition(bullish_flip, "QWave: Bullish Flip", "QWave crossed above zero â€” bulls taking control")
alertcondition(bearish_flip, "QWave: Bearish Flip", "QWave crossed below zero â€” bears taking control")
alertcondition(entered_bull, "QWave: Entered Bull Zone", "QWave crossed above +30 â€” strong buying pressure")
alertcondition(entered_bear, "QWave: Entered Bear Zone", "QWave crossed below -30 â€” strong selling pressure")
alertcondition(entered_strong_bull, "QWave: Strong Bull Zone", "QWave crossed above +60 â€” aggressive buying")
alertcondition(entered_strong_bear, "QWave: Strong Bear Zone", "QWave crossed below -60 â€” aggressive selling")
alertcondition(trend_emerging, "QWave: ADX Trend Emerging", "ADX crossed above 20 â€” trend developing from consolidation")
alertcondition(trend_dying, "QWave: ADX Trend Dying", "ADX crossed below 20 â€” trend weakening to consolidation")
alertcondition(bearish_divergence, "QWave: Bearish Divergence", "Price higher high but QWave lower high â€” potential reversal")
alertcondition(bullish_divergence, "QWave: Bullish Divergence", "Price lower low but QWave higher low â€” potential reversal")

// ==================== WEBHOOK ALERT ====================
// Dynamic webhook alert with full payload (fires on any significant state change)
bool any_alert = (alert_on_flip and (bullish_flip or bearish_flip)) or (alert_on_zone and (entered_bull or entered_bear or entered_strong_bull or entered_strong_bear)) or (alert_on_trend and trend_emerging) or bearish_divergence or bullish_divergence

if any_alert
    string alert_type = bullish_flip ? "flip_bullish" : bearish_flip ? "flip_bearish" : entered_strong_bull ? "strong_bull" : entered_strong_bear ? "strong_bear" : entered_bull ? "zone_bull" : entered_bear ? "zone_bear" : trend_emerging ? "trend_emerging" : bearish_divergence ? "divergence_bearish" : bullish_divergence ? "divergence_bullish" : "unknown"
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"qwave","alert_type":"' + alert_type + '","qwave_score":' + str.tostring(qwave, "#.#") + ',"zone":"' + zone_name + '","zone_num":' + str.tostring(zone) + ',"adx":' + str.tostring(adx_val, "#.#") + ',"di_plus":' + str.tostring(di_plus, "#.#") + ',"di_minus":' + str.tostring(di_minus, "#.#") + ',"slope_state":"' + slope_state + '","bars_in_zone":' + str.tostring(bars_in_zone) + ',"last_flip":"' + last_flip_dir + '","bars_since_flip":' + str.tostring(bars_since_flip) + ',"settings_mode":"' + settings_mode + '","adx_length":' + str.tostring(adx_length) + ',"smoothing":' + str.tostring(smooth_len) + ',"price":' + str.tostring(close, "#.##") + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
