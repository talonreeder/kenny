// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: QCloud - Step MA Cloud", overlay=true, max_labels_count=500)

// ============================================================================
// QCLOUD v2 â€” STEP MOVING AVERAGE CLOUD
// ============================================================================
// Creates a visual cloud of 5 stepped MAs. Cloud color = trend direction/strength.
// Full green = strong bullish, Full red = strong bearish.
//
// v2 ENHANCEMENTS over v1:
//   1. Auto-optimized settings per symbol/timeframe (lookup tables)
//   2. 7-tier state system (strong_bullish â†’ strong_bearish)
//   3. Cloud dynamics: width tracking, squeeze detection, slope analysis
//   4. Price position: above/inside/below cloud with distance %
//   5. Info table with all real-time metrics
//   6. Enhanced webhook payload with full analytics
//   7. Hidden plot exports for Master Confluence
//   8. alertcondition() entries for TradingView alerts
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
// Detects current symbol and timeframe, selects optimal parameters automatically.
// TradingView settings are GLOBAL (not per-chart), so this solves the problem
// of needing different settings for SPY vs TSLA vs different timeframes.

// Determine timeframe group
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode: Auto (recommended) or Manual override
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe. Manual = use your custom values below.")

// Manual override inputs (only used when settings_mode == "Manual")
string manual_ma_type = input.string("EMA", "MA Type", options=["SMA", "EMA", "WMA", "VWMA"], group="ðŸ”§ Manual Settings")
int manual_base_length = input.int(10, "Base Length", minval=5, maxval=50, group="ðŸ”§ Manual Settings", tooltip="Period for the fastest MA")
float manual_step_mult = input.float(1.5, "Step Multiplier", minval=1.1, maxval=3.0, step=0.1, group="ðŸ”§ Manual Settings", tooltip="Multiplier between each MA period")
int manual_smoothing = input.int(2, "Flip Smoothing", minval=1, maxval=10, group="ðŸ”§ Manual Settings", tooltip="Bars required to confirm state change")

// Visual settings
int fill_transparency = input.int(82, "Cloud Transparency", minval=50, maxval=95, group="ðŸŽ¨ Visuals")
bool show_ma_lines = input.bool(false, "Show Individual MA Lines", group="ðŸŽ¨ Visuals")
bool show_labels = input.bool(true, "Show State Labels", group="ðŸŽ¨ Visuals")
bool show_squeeze_labels = input.bool(true, "Show Squeeze Labels", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts", tooltip="Secret key for webhook authentication")
bool alert_on_flip = input.bool(true, "Alert on Cloud Flip", group="ðŸ”” Alerts")
bool alert_on_full = input.bool(true, "Alert on Full Bull/Bear", group="ðŸ”” Alerts")
bool alert_on_squeeze = input.bool(false, "Alert on Squeeze", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py on 2026-02-13 21:43:02
// These values are REAL optimized results from backtesting against historical data.
// DO NOT manually edit â€” re-run the optimizer to update.

f_auto_base_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 16
    else if t == "QQQ"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15
    else if t == "TSLA"
        tf_group == "scalp" ? 15 : tf_group == "intraday" ? 16 : 16
    else if t == "NVDA"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15
    else if t == "META"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15
    else if t == "NFLX"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15
    else if t == "AAPL"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 16
    else if t == "GOOGL"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15
    else if t == "MSFT"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 15 : 15
    else if t == "AMZN"
        tf_group == "scalp" ? 15 : tf_group == "intraday" ? 16 : 15
    else if t == "AMD"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 15 : 16
    else
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 15

f_auto_step_mult() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "QQQ"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.7
    else if t == "TSLA"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "NVDA"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.6 : 1.6
    else if t == "META"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "NFLX"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "AAPL"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "GOOGL"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "MSFT"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8
    else if t == "AMZN"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.7
    else if t == "AMD"
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.7
    else
        tf_group == "scalp" ? 1.8 : tf_group == "intraday" ? 1.8 : 1.8

f_auto_smoothing() =>
    // Optimizer found smoothing=3 optimal across ALL symbols and timeframes
    3

// Apply settings based on mode
int base_length = settings_mode == "Auto" ? f_auto_base_length() : manual_base_length
float step_mult = settings_mode == "Auto" ? f_auto_step_mult() : manual_step_mult
int smoothing = settings_mode == "Auto" ? f_auto_smoothing() : manual_smoothing
// Auto mode always uses EMA (most responsive); Manual mode uses user choice
string ma_type = settings_mode == "Auto" ? "EMA" : manual_ma_type

// ==================== MA CALCULATIONS ====================
// Calculate MA lengths using step multiplier
int len1 = base_length
int len2 = math.round(base_length * math.pow(step_mult, 1))
int len3 = math.round(base_length * math.pow(step_mult, 2))
int len4 = math.round(base_length * math.pow(step_mult, 3))
int len5 = math.round(base_length * math.pow(step_mult, 4))

// Pre-calculate ALL MA types at top level (Pine Script v6 requirement: ta.* at global scope)
// MA1
float ma1_sma = ta.sma(close, len1)
float ma1_ema = ta.ema(close, len1)
float ma1_wma = ta.wma(close, len1)
float ma1_vwma = ta.vwma(close, len1)
// MA2
float ma2_sma = ta.sma(close, len2)
float ma2_ema = ta.ema(close, len2)
float ma2_wma = ta.wma(close, len2)
float ma2_vwma = ta.vwma(close, len2)
// MA3
float ma3_sma = ta.sma(close, len3)
float ma3_ema = ta.ema(close, len3)
float ma3_wma = ta.wma(close, len3)
float ma3_vwma = ta.vwma(close, len3)
// MA4
float ma4_sma = ta.sma(close, len4)
float ma4_ema = ta.ema(close, len4)
float ma4_wma = ta.wma(close, len4)
float ma4_vwma = ta.vwma(close, len4)
// MA5
float ma5_sma = ta.sma(close, len5)
float ma5_ema = ta.ema(close, len5)
float ma5_wma = ta.wma(close, len5)
float ma5_vwma = ta.vwma(close, len5)

// Select the appropriate MA based on type
float ma1 = ma_type == "SMA" ? ma1_sma : ma_type == "EMA" ? ma1_ema : ma_type == "WMA" ? ma1_wma : ma1_vwma
float ma2 = ma_type == "SMA" ? ma2_sma : ma_type == "EMA" ? ma2_ema : ma_type == "WMA" ? ma2_wma : ma2_vwma
float ma3 = ma_type == "SMA" ? ma3_sma : ma_type == "EMA" ? ma3_ema : ma_type == "WMA" ? ma3_wma : ma3_vwma
float ma4 = ma_type == "SMA" ? ma4_sma : ma_type == "EMA" ? ma4_ema : ma_type == "WMA" ? ma4_wma : ma4_vwma
float ma5 = ma_type == "SMA" ? ma5_sma : ma_type == "EMA" ? ma5_ema : ma_type == "WMA" ? ma5_wma : ma5_vwma

// ==================== LAYER SCORING (0-5) ====================
// Layer is bullish when: price > MA AND that MA > next slower MA
bool layer1_bull = close > ma1 and ma1 > ma2
bool layer2_bull = close > ma2 and ma2 > ma3
bool layer3_bull = close > ma3 and ma3 > ma4
bool layer4_bull = close > ma4 and ma4 > ma5
bool layer5_bull = close > ma5

int bullish_count_raw = (layer1_bull ? 1 : 0) + (layer2_bull ? 1 : 0) + (layer3_bull ? 1 : 0) + (layer4_bull ? 1 : 0) + (layer5_bull ? 1 : 0)

// ==================== SMOOTHING (prevent whipsaws) ====================
var int confirmed_count = 3  // Start neutral
var int pending_count = 3
var int streak = 0

if bullish_count_raw != pending_count
    pending_count := bullish_count_raw
    streak := 1
else if bullish_count_raw == pending_count and pending_count != confirmed_count
    streak := streak + 1
    if streak >= smoothing
        confirmed_count := pending_count
        streak := 0
else
    streak := 0

int bullish_count = confirmed_count

// ==================== 7-TIER STATE SYSTEM ====================
// More granular than v1's simple bullish/bearish/neutral
string cloud_state = switch bullish_count
    5 => "STRONG BULL"
    4 => "BULLISH"
    3 => "WEAK BULL"
    2 => "WEAK BEAR"
    1 => "BEARISH"
    0 => "STRONG BEAR"
    => "NEUTRAL"

// Simplified direction for trading decisions
string cloud_direction = bullish_count >= 4 ? "bullish" : bullish_count <= 1 ? "bearish" : "neutral"

// Trend strength as percentage (0-100)
float trend_strength = (bullish_count / 5.0) * 100

// ==================== CLOUD DYNAMICS ====================
// Cloud width = distance between fastest and slowest MA
float cloud_width = math.abs(ma1 - ma5)
float cloud_width_pct = (cloud_width / close) * 100

// Average cloud width over last 20 bars for squeeze detection
float avg_cloud_width = ta.sma(cloud_width, 20)

// Squeeze: cloud width < 60% of its 20-bar average
bool is_squeeze = cloud_width < (avg_cloud_width * 0.6)
bool squeeze_started = is_squeeze and not is_squeeze[1]
bool squeeze_ended = not is_squeeze and is_squeeze[1]

// Cloud slope: is the cloud expanding or contracting?
float cloud_slope = cloud_width - cloud_width[3]
string cloud_dynamics = cloud_slope > 0 ? "EXPANDING" : cloud_slope < 0 ? "CONTRACTING" : "FLAT"

// MA1 slope for trend acceleration
float ma1_slope = ma1 - ma1[3]
string trend_momentum = (ma1_slope > 0 and bullish_count >= 3) or (ma1_slope < 0 and bullish_count <= 2) ? "ACCELERATING" : "DECELERATING"

// ==================== PRICE POSITION ====================
// Where is price relative to the cloud?
float cloud_top = math.max(ma1, ma5)
float cloud_bottom = math.min(ma1, ma5)

string price_position = close > cloud_top ? "ABOVE" : close < cloud_bottom ? "BELOW" : "INSIDE"

// Distance from price to nearest cloud edge (as percentage)
float distance_to_cloud = price_position == "ABOVE" ? ((close - cloud_top) / close) * 100 : price_position == "BELOW" ? ((cloud_bottom - close) / close) * 100 : 0.0

// ==================== STATE CHANGE DETECTION ====================
// Only on confirmed bars to avoid repainting
bool became_strong_bull = bullish_count == 5 and bullish_count[1] != 5 and barstate.isconfirmed
bool became_strong_bear = bullish_count == 0 and bullish_count[1] != 0 and barstate.isconfirmed
bool flipped_bullish = bullish_count >= 3 and bullish_count[1] < 3 and barstate.isconfirmed
bool flipped_bearish = bullish_count <= 2 and bullish_count[1] > 2 and barstate.isconfirmed

// Combined alert conditions
bool any_flip_alert = alert_on_flip and (flipped_bullish or flipped_bearish)
bool any_full_alert = alert_on_full and (became_strong_bull or became_strong_bear)
bool any_squeeze_alert = alert_on_squeeze and squeeze_started
bool any_alert = any_flip_alert or any_full_alert or any_squeeze_alert

// ==================== VISUALIZATION ====================
// Cloud color based on bullish layer count (6-tier color scheme)
color cloud_color = switch bullish_count
    5 => color.new(color.green, fill_transparency)
    4 => color.new(color.lime, fill_transparency)
    3 => color.new(color.yellow, fill_transparency + 5)
    2 => color.new(color.orange, fill_transparency)
    1 => color.new(color.red, fill_transparency)
    0 => color.new(color.maroon, fill_transparency)
    => color.new(color.gray, fill_transparency)

// State label color (solid, for labels and table)
color state_color = bullish_count >= 4 ? color.green : bullish_count == 3 ? color.yellow : bullish_count == 2 ? color.orange : color.red

// Optional MA lines
plot(show_ma_lines ? ma1 : na, "MA1 (Fastest)", color=color.new(color.blue, 70), linewidth=1)
plot(show_ma_lines ? ma2 : na, "MA2", color=color.new(color.blue, 75), linewidth=1)
plot(show_ma_lines ? ma3 : na, "MA3 (Mid)", color=color.new(color.blue, 80), linewidth=1)
plot(show_ma_lines ? ma4 : na, "MA4", color=color.new(color.blue, 85), linewidth=1)
plot(show_ma_lines ? ma5 : na, "MA5 (Slowest)", color=color.new(color.purple, 70), linewidth=1)

// Cloud fill between fastest and slowest MA
p_fast = plot(ma1, "Cloud Top", color=na, display=display.none)
p_slow = plot(ma5, "Cloud Bottom", color=na, display=display.none)
fill(p_fast, p_slow, color=cloud_color, title="Cloud Fill")

// State flip labels
if show_labels and flipped_bullish
    label.new(bar_index, low, "â˜ BULL", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)
if show_labels and flipped_bearish
    label.new(bar_index, high, "â˜ BEAR", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// Full strength labels
if show_labels and became_strong_bull
    label.new(bar_index, low, "â˜ 5/5", style=label.style_label_up, color=color.lime, textcolor=color.black, size=size.tiny)
if show_labels and became_strong_bear
    label.new(bar_index, high, "â˜ 0/5", style=label.style_label_down, color=color.maroon, textcolor=color.white, size=size.tiny)

// Squeeze labels
if show_squeeze_labels and squeeze_started
    label.new(bar_index, high, "â—† SQZ", style=label.style_label_down, color=color.yellow, textcolor=color.black, size=size.tiny)

// ==================== INFO TABLE ====================
// Position lookup
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Indicator name + version
    table.cell(info_table, 0, 0, "QCloud v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: State
    table.cell(info_table, 0, 1, "State", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 1, cloud_state, text_color=state_color, text_size=size.small)

    // Row 2: Layers
    table.cell(info_table, 0, 2, "Layers", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 2, str.tostring(bullish_count) + "/5", text_color=state_color, text_size=size.small)

    // Row 3: Price Position
    table.cell(info_table, 0, 3, "Price", text_color=color.gray, text_size=size.tiny)
    color pos_color = price_position == "ABOVE" ? color.green : price_position == "BELOW" ? color.red : color.yellow
    table.cell(info_table, 1, 3, price_position, text_color=pos_color, text_size=size.small)

    // Row 4: Width %
    table.cell(info_table, 0, 4, "Width", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 4, str.tostring(cloud_width_pct, "#.##") + "%", text_color=color.white, text_size=size.small)

    // Row 5: Cloud dynamics
    table.cell(info_table, 0, 5, "Cloud", text_color=color.gray, text_size=size.tiny)
    color dyn_color = cloud_dynamics == "EXPANDING" ? color.green : cloud_dynamics == "CONTRACTING" ? color.orange : color.gray
    table.cell(info_table, 1, 5, is_squeeze ? "â—† SQUEEZE" : cloud_dynamics, text_color=is_squeeze ? color.yellow : dyn_color, text_size=size.small)

    // Row 6: Settings mode
    table.cell(info_table, 0, 6, "Settings", text_color=color.gray, text_size=size.tiny)
    string settings_display = settings_mode == "Auto" ? "Auto" : "Manual"
    table.cell(info_table, 1, 6, settings_display, text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 7: Active params
    table.cell(info_table, 0, 7, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, str.tostring(base_length) + " / " + str.tostring(step_mult, "#.##") + " / " + str.tostring(smoothing), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
// For Master Confluence to read via source()
plot(bullish_count, "X_BullCount", display=display.none)
plot(trend_strength, "X_TrendStrength", display=display.none)
plot(cloud_width_pct, "X_CloudWidthPct", display=display.none)
plot(is_squeeze ? 1 : 0, "X_IsSqueeze", display=display.none)
plot(cloud_direction == "bullish" ? 1 : cloud_direction == "bearish" ? -1 : 0, "X_Direction", display=display.none)
plot(ma1, "X_MA1", display=display.none)
plot(ma5, "X_MA5", display=display.none)

// ==================== ALERTS ====================
// Standard TradingView alertcondition (const string messages â€” no series allowed)
alertcondition(became_strong_bull, "QCloud: 5/5 Fully Bullish", "QCloud turned FULLY BULLISH (5/5 layers)")
alertcondition(became_strong_bear, "QCloud: 0/5 Fully Bearish", "QCloud turned FULLY BEARISH (0/5 layers)")
alertcondition(flipped_bullish, "QCloud: Flipped Bullish", "QCloud flipped to BULLISH (3+ layers)")
alertcondition(flipped_bearish, "QCloud: Flipped Bearish", "QCloud flipped to BEARISH (2 or fewer layers)")
alertcondition(squeeze_started, "QCloud: Squeeze Detected", "QCloud squeeze detected â€” expect volatility expansion")

// Dynamic webhook alert with full payload (fires on any significant state change)
if any_alert
    string alert_type = became_strong_bull ? "strong_bullish" : became_strong_bear ? "strong_bearish" : flipped_bullish ? "flip_bullish" : flipped_bearish ? "flip_bearish" : squeeze_started ? "squeeze_start" : "unknown"
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"qcloud","alert_type":"' + alert_type + '","state":"' + cloud_state + '","direction":"' + cloud_direction + '","bullish_count":' + str.tostring(bullish_count) + ',"trend_strength":' + str.tostring(trend_strength, "#.#") + ',"price_position":"' + price_position + '","cloud_width_pct":' + str.tostring(cloud_width_pct, "#.##") + ',"is_squeeze":' + str.tostring(is_squeeze) + ',"cloud_dynamics":"' + cloud_dynamics + '","ma1":' + str.tostring(ma1, "#.##") + ',"ma3":' + str.tostring(ma3, "#.##") + ',"ma5":' + str.tostring(ma5, "#.##") + ',"price":' + str.tostring(close, "#.##") + ',"settings_mode":"' + settings_mode + '","base_length":' + str.tostring(base_length) + ',"step_mult":' + str.tostring(step_mult, "#.##") + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
