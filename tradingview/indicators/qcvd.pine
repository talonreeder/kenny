// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: QCVD - Cumulative Volume Delta", shorttitle="QCVD", overlay=false, max_labels_count=500)

// ============================================================================
// QCVD v2 â€” CUMULATIVE VOLUME DELTA
// ============================================================================
// Approximates net buying vs selling pressure using candle close position
// within the high-low range. Close near high = buying, close near low = selling.
//
// CVD (running total of delta) reveals hidden accumulation/distribution that
// price alone doesn't show. When CVD diverges from price, smart money is
// positioning before the move.
//
// v2 ENHANCEMENTS over v1:
//   1. Auto-optimized smoothing and trend detection per symbol/timeframe
//   2. Delta momentum (rate of change of CVD)
//   3. Large delta spike detection (institutional activity)
//   4. CVD divergence detection (CVD vs price)
//   5. Per-bar delta histogram overlay
//   6. Info table with real-time metrics
//   7. Hidden plot exports for Master Confluence
//   8. Enhanced webhook payload
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe.")

// Manual override inputs
int manual_smooth_length = input.int(3, "Delta Smoothing", minval=1, maxval=10, group="ðŸ”§ Manual Settings")
int manual_trend_length = input.int(14, "CVD Trend Length", minval=5, maxval=40, group="ðŸ”§ Manual Settings")

// Visual settings
bool show_histogram = input.bool(true, "Show Delta Histogram", group="ðŸŽ¨ Visuals")
bool show_flip_labels = input.bool(true, "Show Trend Flip Labels", group="ðŸŽ¨ Visuals")
bool show_spike_labels = input.bool(true, "Show Delta Spike Labels", group="ðŸŽ¨ Visuals")
bool show_divergence_labels = input.bool(true, "Show Divergence Labels", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Divergence settings
int pivot_lookback = input.int(5, "Pivot Lookback", minval=3, maxval=15, group="ðŸ“ Divergence")
int div_max_lookback = input.int(40, "Divergence Max Lookback", minval=15, maxval=80, group="ðŸ“ Divergence")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py â€” REAL optimized values from backtesting
// Placeholder values will be replaced after running: python -m scripts.optimize_params --indicator qcvd

f_auto_smooth_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "QQQ"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "TSLA"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "NVDA"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "META"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "NFLX"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AAPL"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "GOOGL"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "MSFT"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AMZN"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AMD"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else
        tf_group == "scalp" ? 3 : tf_group == "intraday" ? 3 : 4

f_auto_trend_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "QQQ"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 20 : 20
    else if t == "TSLA"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "NVDA"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 25 : 20
    else if t == "META"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else if t == "NFLX"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 20
    else if t == "AAPL"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 25
    else if t == "GOOGL"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 20
    else if t == "MSFT"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 20 : 20
    else if t == "AMZN"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 20 : 20
    else if t == "AMD"
        tf_group == "scalp" ? 25 : tf_group == "intraday" ? 25 : 25
    else
        tf_group == "scalp" ? 14 : tf_group == "intraday" ? 14 : 16

// Apply settings
int smooth_length = settings_mode == "Auto" ? f_auto_smooth_length() : manual_smooth_length
int trend_length = settings_mode == "Auto" ? f_auto_trend_length() : manual_trend_length

// Fixed parameters
int momentum_length = 10
float spike_mult = 3.0

// ==================== CORE CALCULATIONS ====================

// --- Step 1: Per-bar delta approximation ---
float bar_range = high - low
float raw_delta = bar_range > 0 ? volume * ((close - low) / bar_range - (high - close) / bar_range) : 0.0
// Simplifies to: volume * (2 * close - high - low) / (high - low)

// --- Step 2: Smoothed delta ---
float smoothed_delta = smooth_length > 1 ? ta.ema(raw_delta, smooth_length) : raw_delta

// --- Step 3: Cumulative Volume Delta ---
var float cvd = 0.0
cvd += smoothed_delta

// --- Step 4: CVD Trend ---
float cvd_sma = ta.sma(cvd, trend_length)
bool cvd_bullish = cvd > cvd_sma
bool cvd_bearish = cvd < cvd_sma
string cvd_trend = cvd_bullish ? "BULL" : "BEAR"

// --- CVD Trend flips ---
bool flipped_bullish = cvd_bullish and not cvd_bullish[1]
bool flipped_bearish = cvd_bearish and not cvd_bearish[1]

// --- Step 5: Delta Momentum ---
float delta_momentum = cvd - nz(cvd[momentum_length])
float mom_threshold = ta.sma(math.abs(delta_momentum), 20) * 0.5
string momentum_state = delta_momentum > mom_threshold ? "ACCEL BUY" : delta_momentum < -mom_threshold ? "ACCEL SELL" : "FLAT"

// --- Delta Spikes ---
float abs_delta = math.abs(smoothed_delta)
float avg_delta = ta.sma(abs_delta, 20)
bool spike_bullish = smoothed_delta > avg_delta * spike_mult and avg_delta > 0
bool spike_bearish = smoothed_delta < -avg_delta * spike_mult and avg_delta > 0

// Track last spike for info table
var string last_spike_text = "NONE"
var int bars_since_spike = 999
if spike_bullish
    last_spike_text := "BUY"
    bars_since_spike := 0
else if spike_bearish
    last_spike_text := "SELL"
    bars_since_spike := 0
else
    bars_since_spike += 1

// --- Bars in current trend ---
var int bars_in_trend = 0
if cvd_bullish != cvd_bullish[1]
    bars_in_trend := 1
else
    bars_in_trend += 1

// ==================== DIVERGENCE DETECTION ====================
// CVD pivots
float cvd_pivot_high = ta.pivothigh(cvd, pivot_lookback, pivot_lookback)
float cvd_pivot_low = ta.pivotlow(cvd, pivot_lookback, pivot_lookback)

// Price pivots
float price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
float price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)

// Track previous pivots
var float prev_cvd_high = na
var float prev_price_high = na
var int prev_high_bar = na
var float prev_cvd_low = na
var float prev_price_low = na
var int prev_low_bar = na

bool bearish_div = false
bool bullish_div = false

// Bearish: price HH + CVD LH (distribution)
if not na(cvd_pivot_high)
    if not na(prev_cvd_high) and not na(prev_price_high)
        int bar_sep = bar_index - nz(prev_high_bar)
        if bar_sep <= div_max_lookback and bar_sep > pivot_lookback
            if price_pivot_high > prev_price_high and cvd_pivot_high < prev_cvd_high
                bearish_div := true
    prev_cvd_high := cvd_pivot_high
    prev_price_high := price_pivot_high
    prev_high_bar := bar_index

// Bullish: price LL + CVD HL (accumulation)
if not na(cvd_pivot_low)
    if not na(prev_cvd_low) and not na(prev_price_low)
        int bar_sep = bar_index - nz(prev_low_bar)
        if bar_sep <= div_max_lookback and bar_sep > pivot_lookback
            if price_pivot_low < prev_price_low and cvd_pivot_low > prev_cvd_low
                bullish_div := true
    prev_cvd_low := cvd_pivot_low
    prev_price_low := price_pivot_low
    prev_low_bar := bar_index

// ==================== VISUAL RENDERING ====================

// --- Delta histogram ---
color hist_color = smoothed_delta >= 0 ? color.new(#4CAF50, 60) : color.new(#F44336, 60)
plot(show_histogram ? smoothed_delta : na, "Delta Histogram", color=hist_color, style=plot.style_columns)

// --- CVD line ---
color cvd_color = cvd_bullish ? color.new(#00E676, 0) : color.new(#F44336, 0)
plot(cvd, "CVD", color=cvd_color, linewidth=2)

// --- CVD SMA ---
plot(cvd_sma, "CVD SMA", color=color.new(color.white, 60), linewidth=1, style=plot.style_line)

// --- Trend flip labels ---
if show_flip_labels and flipped_bullish
    label.new(bar_index, cvd, "â–² BULL", style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white, size=size.small)

if show_flip_labels and flipped_bearish
    label.new(bar_index, cvd, "â–¼ BEAR", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small)

// --- Spike labels ---
if show_spike_labels and spike_bullish
    label.new(bar_index, cvd, "ðŸ”º BUY", style=label.style_label_up, color=color.new(#00E676, 10), textcolor=color.black, size=size.tiny)

if show_spike_labels and spike_bearish
    label.new(bar_index, cvd, "ðŸ”» SELL", style=label.style_label_down, color=color.new(#D50000, 10), textcolor=color.white, size=size.tiny)

// --- Divergence labels ---
if show_divergence_labels and bearish_div
    label.new(bar_index - pivot_lookback, cvd[pivot_lookback], "DIV â–¼", style=label.style_label_down, color=color.new(#FF5722, 20), textcolor=color.white, size=size.small)

if show_divergence_labels and bullish_div
    label.new(bar_index - pivot_lookback, cvd[pivot_lookback], "DIV â–²", style=label.style_label_up, color=color.new(#4CAF50, 20), textcolor=color.white, size=size.small)

// ==================== INFO TABLE ====================
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Name
    table.cell(info_table, 0, 0, "QCVD v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: CVD Trend
    table.cell(info_table, 0, 1, "Trend", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 1, cvd_trend + " (" + str.tostring(bars_in_trend) + ")", text_color=cvd_bullish ? color.green : color.red, text_size=size.small)

    // Row 2: Current delta
    table.cell(info_table, 0, 2, "Delta", text_color=color.gray, text_size=size.tiny)
    color delta_color = smoothed_delta > 0 ? color.green : color.red
    table.cell(info_table, 1, 2, str.tostring(smoothed_delta, "#.0"), text_color=delta_color, text_size=size.small)

    // Row 3: Momentum
    table.cell(info_table, 0, 3, "Momentum", text_color=color.gray, text_size=size.tiny)
    color mom_color = momentum_state == "ACCEL BUY" ? color.green : momentum_state == "ACCEL SELL" ? color.red : color.gray
    table.cell(info_table, 1, 3, momentum_state, text_color=mom_color, text_size=size.small)

    // Row 4: Last spike
    table.cell(info_table, 0, 4, "Last Spike", text_color=color.gray, text_size=size.tiny)
    string spike_text = bars_since_spike < 100 ? last_spike_text + " (" + str.tostring(bars_since_spike) + " ago)" : "NONE"
    color spike_clr = last_spike_text == "BUY" ? color.green : last_spike_text == "SELL" ? color.red : color.gray
    table.cell(info_table, 1, 4, spike_text, text_color=spike_clr, text_size=size.small)

    // Row 5: Volume
    table.cell(info_table, 0, 5, "Volume", text_color=color.gray, text_size=size.tiny)
    float vol_ratio = avg_delta > 0 ? abs_delta / avg_delta : 1.0
    string vol_text = vol_ratio > 2.0 ? "HIGH" : vol_ratio > 1.0 ? "ABOVE AVG" : vol_ratio > 0.5 ? "NORMAL" : "LOW"
    color vol_clr = vol_ratio > 2.0 ? color.lime : vol_ratio > 1.0 ? color.green : color.gray
    table.cell(info_table, 1, 5, vol_text + " (" + str.tostring(vol_ratio, "#.#") + "x)", text_color=vol_clr, text_size=size.small)

    // Row 6: Settings
    table.cell(info_table, 0, 6, "Settings", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 6, settings_mode == "Auto" ? "Auto" : "Manual", text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 7: Params
    table.cell(info_table, 0, 7, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, "Sm:" + str.tostring(smooth_length) + " Tr:" + str.tostring(trend_length), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
plot(cvd, "X_QCVD", display=display.none)
plot(cvd_bullish ? 1 : -1, "X_QCVDTrend", display=display.none)
plot(smoothed_delta, "X_QCVDDelta", display=display.none)
plot(delta_momentum, "X_QCVDMomentum", display=display.none)
plot(spike_bullish ? 1 : spike_bearish ? -1 : 0, "X_QCVDSpike", display=display.none)

// ==================== ALERTS ====================
alertcondition(flipped_bullish, "QCVD: Trend Flip Bullish", "CVD crossed above trend line â€” net buying flow increasing")
alertcondition(flipped_bearish, "QCVD: Trend Flip Bearish", "CVD crossed below trend line â€” net selling flow increasing")
alertcondition(spike_bullish, "QCVD: Buy Spike", "Large bullish delta spike â€” institutional buying detected")
alertcondition(spike_bearish, "QCVD: Sell Spike", "Large bearish delta spike â€” institutional selling detected")
alertcondition(bullish_div, "QCVD: Bullish Divergence", "Price lower low but CVD higher low â€” hidden accumulation")
alertcondition(bearish_div, "QCVD: Bearish Divergence", "Price higher high but CVD lower high â€” hidden distribution")

// ==================== WEBHOOK ALERT ====================
bool any_alert = flipped_bullish or flipped_bearish or spike_bullish or spike_bearish or bullish_div or bearish_div

if any_alert
    string alert_type = flipped_bullish ? "flip_bull" : flipped_bearish ? "flip_bear" : spike_bullish ? "spike_buy" : spike_bearish ? "spike_sell" : bullish_div ? "div_bull" : "div_bear"
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"qcvd","alert_type":"' + alert_type + '","cvd_trend":"' + cvd_trend + '","delta":' + str.tostring(smoothed_delta, "#.#") + ',"momentum":"' + momentum_state + '","settings_mode":"' + settings_mode + '","smooth_length":' + str.tostring(smooth_length) + ',"trend_length":' + str.tostring(trend_length) + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
