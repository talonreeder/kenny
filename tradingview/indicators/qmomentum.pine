// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: QMomentum - RSI Divergence Oscillator", shorttitle="QMomentum", overlay=false, max_labels_count=500)

// ============================================================================
// QMOMENTUM v2 â€” RSI WITH STOCHRSI OVERLAY & DIVERGENCE DETECTION
// ============================================================================
// RSI measures the speed and magnitude of price changes on a 0-100 scale.
// StochRSI applies Stochastic to RSI itself for extra sensitivity.
// Automated divergence detection catches momentum failures before price confirms.
//
// Divergence = momentum failing to confirm price action â†’ earliest reversal warning.
//
// v2 ENHANCEMENTS over v1:
//   1. Auto-optimized RSI length per symbol/timeframe
//   2. Stochastic RSI overlay for additional sensitivity
//   3. Divergence quality scoring (â˜… to â˜…â˜…â˜…)
//   4. OB/OS duration tracking (long stays = strong trend, short = quick reversal)
//   5. Zone exit signals (leaving OB/OS = entry opportunity)
//   6. Info table with real-time metrics
//   7. Hidden plot exports for Master Confluence
//   8. Enhanced webhook payload
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe.")

// Manual override inputs
int manual_rsi_length = input.int(14, "RSI Length", minval=5, maxval=30, group="ðŸ”§ Manual Settings")
int manual_stoch_length = input.int(14, "StochRSI Length", minval=5, maxval=30, group="ðŸ”§ Manual Settings")

// Visual settings
bool show_stoch_rsi = input.bool(true, "Show StochRSI Overlay", group="ðŸŽ¨ Visuals")
bool show_divergence_labels = input.bool(true, "Show Divergence Labels", group="ðŸŽ¨ Visuals")
bool show_zone_exits = input.bool(true, "Show Zone Exit Labels", group="ðŸŽ¨ Visuals")
bool show_zone_bg = input.bool(true, "Show OB/OS Background", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Divergence settings
int pivot_lookback = input.int(5, "Pivot Lookback", minval=3, maxval=15, group="ðŸ“ Divergence")
int div_max_lookback = input.int(40, "Divergence Max Lookback (bars)", minval=15, maxval=80, group="ðŸ“ Divergence")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py â€” REAL optimized values from backtesting
// Placeholder values will be replaced after running: python -m scripts.optimize_params --indicator qmomentum

f_auto_rsi_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 20
    else if t == "QQQ"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 14 : 20
    else if t == "TSLA"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 16 : 18
    else if t == "NVDA"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 20 : 20
    else if t == "META"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 18
    else if t == "NFLX"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 14 : 18
    else if t == "AAPL"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 18 : 18
    else if t == "GOOGL"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 18 : 20
    else if t == "MSFT"
        tf_group == "scalp" ? 12 : tf_group == "intraday" ? 18 : 20
    else if t == "AMZN"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 18 : 16
    else if t == "AMD"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 18
    else
        tf_group == "scalp" ? 14 : tf_group == "intraday" ? 14 : 16

f_auto_stoch_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 10 : tf_group == "intraday" ? 10 : 18
    else if t == "QQQ"
        tf_group == "scalp" ? 12 : tf_group == "intraday" ? 14 : 18
    else if t == "TSLA"
        tf_group == "scalp" ? 10 : tf_group == "intraday" ? 10 : 12
    else if t == "NVDA"
        tf_group == "scalp" ? 10 : tf_group == "intraday" ? 18 : 18
    else if t == "META"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 18 : 12
    else if t == "NFLX"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 14 : 12
    else if t == "AAPL"
        tf_group == "scalp" ? 12 : tf_group == "intraday" ? 12 : 12
    else if t == "GOOGL"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 12 : 18
    else if t == "MSFT"
        tf_group == "scalp" ? 12 : tf_group == "intraday" ? 12 : 18
    else if t == "AMZN"
        tf_group == "scalp" ? 10 : tf_group == "intraday" ? 12 : 10
    else if t == "AMD"
        tf_group == "scalp" ? 18 : tf_group == "intraday" ? 18 : 12
    else
        tf_group == "scalp" ? 14 : tf_group == "intraday" ? 14 : 14

// Apply settings
int rsi_length = settings_mode == "Auto" ? f_auto_rsi_length() : manual_rsi_length
int stoch_length = settings_mode == "Auto" ? f_auto_stoch_length() : manual_stoch_length

// Fixed parameters
float ob_level = 70.0
float os_level = 30.0
float extreme_ob = 80.0
float extreme_os = 20.0
int stoch_k_smooth = 3
int stoch_d_smooth = 3

// ==================== CORE CALCULATIONS ====================

// --- RSI ---
float rsi_val = ta.rsi(close, rsi_length)

// --- Stochastic RSI ---
float stoch_rsi_raw = ta.stoch(rsi_val, rsi_val, rsi_val, stoch_length)
float stoch_k = ta.sma(stoch_rsi_raw, stoch_k_smooth)
float stoch_d = ta.sma(stoch_k, stoch_d_smooth)

// ==================== ZONE CLASSIFICATION ====================
// 1=Extreme OS, 2=Oversold, 3=Neutral, 4=Overbought, 5=Extreme OB
int zone = rsi_val > extreme_ob ? 5 : rsi_val > ob_level ? 4 : rsi_val > os_level ? 3 : rsi_val > extreme_os ? 2 : 1
string zone_name = switch zone
    5 => "EXTREME OB"
    4 => "OVERBOUGHT"
    3 => "NEUTRAL"
    2 => "OVERSOLD"
    1 => "EXTREME OS"
    => "NEUTRAL"

// ==================== OB/OS EVENTS ====================
bool entered_ob = rsi_val >= ob_level and rsi_val[1] < ob_level
bool entered_os = rsi_val <= os_level and rsi_val[1] > os_level
bool left_ob = rsi_val < ob_level and rsi_val[1] >= ob_level
bool left_os = rsi_val > os_level and rsi_val[1] <= os_level

// OB/OS duration tracking
var int ob_bars = 0
var int os_bars = 0
if rsi_val >= ob_level
    ob_bars += 1
else
    ob_bars := 0
if rsi_val <= os_level
    os_bars += 1
else
    os_bars := 0

// Track current extreme zone duration for info table
int extreme_bars = math.max(ob_bars, os_bars)

// ==================== STOCHRSI CROSSES ====================
bool stoch_bull_cross = ta.crossover(stoch_k, stoch_d)
bool stoch_bear_cross = ta.crossunder(stoch_k, stoch_d)
bool stoch_bull_in_os = stoch_bull_cross and rsi_val < os_level
bool stoch_bear_in_ob = stoch_bear_cross and rsi_val > ob_level

// ==================== DIVERGENCE DETECTION ====================
// Pivot detection on RSI
float rsi_pivot_high = ta.pivothigh(rsi_val, pivot_lookback, pivot_lookback)
float rsi_pivot_low = ta.pivotlow(rsi_val, pivot_lookback, pivot_lookback)

// Pivot detection on price
float price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
float price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)

// Track previous pivots
var float prev_rsi_high = na
var float prev_price_high = na
var int prev_high_bar = na
var float prev_rsi_low = na
var float prev_price_low = na
var int prev_low_bar = na

// Divergence signals
bool regular_bear_div = false
int bear_div_quality = 0
bool regular_bull_div = false
int bull_div_quality = 0
bool hidden_bear_div = false
bool hidden_bull_div = false

// --- Bearish divergence: price HH + RSI LH ---
if not na(rsi_pivot_high)
    if not na(prev_rsi_high) and not na(prev_price_high)
        int bar_sep = bar_index - nz(prev_high_bar)
        if bar_sep <= div_max_lookback and bar_sep > pivot_lookback
            // Regular bearish: price higher high, RSI lower high
            if price_pivot_high > prev_price_high and rsi_pivot_high < prev_rsi_high
                regular_bear_div := true
                float rsi_magnitude = prev_rsi_high - rsi_pivot_high
                bool in_ob = rsi_pivot_high > ob_level or prev_rsi_high > ob_level
                bear_div_quality := bar_sep > 15 and rsi_magnitude > 5 and in_ob ? 3 : bar_sep > 10 and rsi_magnitude > 3 ? 2 : 1

            // Hidden bearish: price lower high, RSI higher high (trend continuation)
            if price_pivot_high < prev_price_high and rsi_pivot_high > prev_rsi_high
                hidden_bear_div := true

    prev_rsi_high := rsi_pivot_high
    prev_price_high := price_pivot_high
    prev_high_bar := bar_index

// --- Bullish divergence: price LL + RSI HL ---
if not na(rsi_pivot_low)
    if not na(prev_rsi_low) and not na(prev_price_low)
        int bar_sep = bar_index - nz(prev_low_bar)
        if bar_sep <= div_max_lookback and bar_sep > pivot_lookback
            // Regular bullish: price lower low, RSI higher low
            if price_pivot_low < prev_price_low and rsi_pivot_low > prev_rsi_low
                regular_bull_div := true
                float rsi_magnitude = rsi_pivot_low - prev_rsi_low
                bool in_os = rsi_pivot_low < os_level or prev_rsi_low < os_level
                bull_div_quality := bar_sep > 15 and rsi_magnitude > 5 and in_os ? 3 : bar_sep > 10 and rsi_magnitude > 3 ? 2 : 1

            // Hidden bullish: price higher low, RSI lower low (trend continuation)
            if price_pivot_low > prev_price_low and rsi_pivot_low < prev_rsi_low
                hidden_bull_div := true

    prev_rsi_low := rsi_pivot_low
    prev_price_low := price_pivot_low
    prev_low_bar := bar_index

// Track last divergence for info table
var string last_div_text = "NONE"
if regular_bear_div
    last_div_text := "Bear " + (bear_div_quality == 3 ? "â˜…â˜…â˜…" : bear_div_quality == 2 ? "â˜…â˜…" : "â˜…")
if regular_bull_div
    last_div_text := "Bull " + (bull_div_quality == 3 ? "â˜…â˜…â˜…" : bull_div_quality == 2 ? "â˜…â˜…" : "â˜…")
if hidden_bear_div
    last_div_text := "H.Bear"
if hidden_bull_div
    last_div_text := "H.Bull"

// Composite divergence signal for exports (+/- quality for regular, +/- 0.5 for hidden)
float div_signal = regular_bull_div ? bull_div_quality : regular_bear_div ? -bear_div_quality : hidden_bull_div ? 0.5 : hidden_bear_div ? -0.5 : 0.0

// ==================== VISUAL RENDERING ====================

// --- RSI line color by zone ---
color rsi_color = switch zone
    5 => color.new(#D50000, 0)   // Extreme OB â€” bright red
    4 => color.new(#F44336, 0)   // Overbought â€” red
    3 => color.new(#FFFFFF, 0)   // Neutral â€” white
    2 => color.new(#4CAF50, 0)   // Oversold â€” green
    1 => color.new(#00E676, 0)   // Extreme OS â€” bright green
    => color.white

// --- RSI plot ---
plot(rsi_val, "RSI", color=rsi_color, linewidth=2)

// --- StochRSI plots ---
plot(show_stoch_rsi ? stoch_k : na, "StochRSI K", color=color.new(#2196F3, 50), linewidth=1)
plot(show_stoch_rsi ? stoch_d : na, "StochRSI D", color=color.new(#FF9800, 50), linewidth=1, style=plot.style_line)

// --- Reference lines ---
hline(80, "80 (Extreme OB)", color=color.new(#F44336, 70), linestyle=hline.style_dashed)
hline(70, "70 (OB)", color=color.new(#F44336, 80), linestyle=hline.style_dotted)
hline(50, "50 (Center)", color=color.new(color.white, 70), linestyle=hline.style_dashed)
hline(30, "30 (OS)", color=color.new(#4CAF50, 80), linestyle=hline.style_dotted)
hline(20, "20 (Extreme OS)", color=color.new(#4CAF50, 70), linestyle=hline.style_dashed)

// --- OB/OS zone backgrounds ---
bgcolor(show_zone_bg and rsi_val >= ob_level ? color.new(#F44336, 92) : show_zone_bg and rsi_val <= os_level ? color.new(#4CAF50, 92) : na, title="OB/OS Background")

// --- Divergence labels ---
if show_divergence_labels and regular_bear_div
    string stars = bear_div_quality == 3 ? "â˜…â˜…â˜…" : bear_div_quality == 2 ? "â˜…â˜…" : "â˜…"
    label.new(bar_index - pivot_lookback, rsi_val[pivot_lookback], "DIV â–¼ " + stars, style=label.style_label_down, color=color.new(#FF5722, 10), textcolor=color.white, size=size.small)

if show_divergence_labels and regular_bull_div
    string stars = bull_div_quality == 3 ? "â˜…â˜…â˜…" : bull_div_quality == 2 ? "â˜…â˜…" : "â˜…"
    label.new(bar_index - pivot_lookback, rsi_val[pivot_lookback], "DIV â–² " + stars, style=label.style_label_up, color=color.new(#4CAF50, 10), textcolor=color.white, size=size.small)

if show_divergence_labels and hidden_bear_div
    label.new(bar_index - pivot_lookback, rsi_val[pivot_lookback], "H.DIV â–¼", style=label.style_label_down, color=color.new(#FF9800, 30), textcolor=color.white, size=size.tiny)

if show_divergence_labels and hidden_bull_div
    label.new(bar_index - pivot_lookback, rsi_val[pivot_lookback], "H.DIV â–²", style=label.style_label_up, color=color.new(#8BC34A, 30), textcolor=color.white, size=size.tiny)

// --- Zone exit labels ---
if show_zone_exits and left_ob
    label.new(bar_index, rsi_val, "â—€ OB", style=label.style_label_left, color=color.new(#F44336, 40), textcolor=color.white, size=size.tiny)

if show_zone_exits and left_os
    label.new(bar_index, rsi_val, "â—€ OS", style=label.style_label_left, color=color.new(#4CAF50, 40), textcolor=color.white, size=size.tiny)

// ==================== INFO TABLE ====================
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Name
    table.cell(info_table, 0, 0, "QMomentum v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: RSI value
    table.cell(info_table, 0, 1, "RSI", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 1, str.tostring(rsi_val, "#.#"), text_color=rsi_color, text_size=size.small)

    // Row 2: Zone
    table.cell(info_table, 0, 2, "Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 2, zone_name, text_color=rsi_color, text_size=size.small)

    // Row 3: StochRSI
    table.cell(info_table, 0, 3, "StochRSI", text_color=color.gray, text_size=size.tiny)
    string stoch_text = str.tostring(stoch_k, "#.#") + " / " + str.tostring(stoch_d, "#.#")
    color stoch_color = stoch_k > stoch_d ? color.green : color.red
    table.cell(info_table, 1, 3, stoch_text, text_color=stoch_color, text_size=size.small)

    // Row 4: OB/OS duration
    table.cell(info_table, 0, 4, "OB/OS Bars", text_color=color.gray, text_size=size.tiny)
    string ob_os_text = ob_bars > 0 ? "OB: " + str.tostring(ob_bars) : os_bars > 0 ? "OS: " + str.tostring(os_bars) : "â€”"
    color ob_os_color = ob_bars > 0 ? color.red : os_bars > 0 ? color.green : color.gray
    table.cell(info_table, 1, 4, ob_os_text, text_color=ob_os_color, text_size=size.small)

    // Row 5: Last divergence
    table.cell(info_table, 0, 5, "Last Div", text_color=color.gray, text_size=size.tiny)
    color div_color = str.contains(last_div_text, "Bull") ? color.green : str.contains(last_div_text, "Bear") ? color.red : color.gray
    table.cell(info_table, 1, 5, last_div_text, text_color=div_color, text_size=size.small)

    // Row 6: Settings
    table.cell(info_table, 0, 6, "Settings", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 6, settings_mode == "Auto" ? "Auto" : "Manual", text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 7: Params
    table.cell(info_table, 0, 7, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, "RSI:" + str.tostring(rsi_length) + " Stoch:" + str.tostring(stoch_length), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
plot(rsi_val, "X_QMomentumRSI", display=display.none)
plot(zone, "X_QMomentumZone", display=display.none)
plot(stoch_k, "X_QMomentumStochK", display=display.none)
plot(stoch_d, "X_QMomentumStochD", display=display.none)
plot(div_signal, "X_QMomentumDiv", display=display.none)
plot(extreme_bars, "X_QMomentumOBOSBars", display=display.none)

// ==================== ALERTS ====================
alertcondition(entered_ob, "QMomentum: Entered Overbought", "RSI entered overbought zone (>70)")
alertcondition(entered_os, "QMomentum: Entered Oversold", "RSI entered oversold zone (<30)")
alertcondition(left_ob, "QMomentum: Left Overbought", "RSI left overbought zone â€” potential short entry")
alertcondition(left_os, "QMomentum: Left Oversold", "RSI left oversold zone â€” potential long entry")
alertcondition(regular_bull_div, "QMomentum: Bullish Divergence", "Bullish RSI divergence â€” price lower low but RSI higher low")
alertcondition(regular_bear_div, "QMomentum: Bearish Divergence", "Bearish RSI divergence â€” price higher high but RSI lower high")
alertcondition(stoch_bull_in_os, "QMomentum: StochRSI Bull Cross (OS)", "StochRSI bullish cross in oversold zone â€” strong buy signal")
alertcondition(stoch_bear_in_ob, "QMomentum: StochRSI Bear Cross (OB)", "StochRSI bearish cross in overbought zone â€” strong sell signal")

// ==================== WEBHOOK ALERT ====================
bool any_alert = entered_ob or entered_os or left_ob or left_os or regular_bull_div or regular_bear_div or stoch_bull_in_os or stoch_bear_in_ob

if any_alert
    string alert_type = regular_bull_div ? "div_bull" : regular_bear_div ? "div_bear" : left_ob ? "left_ob" : left_os ? "left_os" : entered_ob ? "entered_ob" : entered_os ? "entered_os" : stoch_bull_in_os ? "stoch_bull_os" : "stoch_bear_ob"
    int div_qual = regular_bull_div ? bull_div_quality : regular_bear_div ? bear_div_quality : 0
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"qmomentum","alert_type":"' + alert_type + '","rsi":' + str.tostring(rsi_val, "#.#") + ',"zone":"' + zone_name + '","stoch_k":' + str.tostring(stoch_k, "#.#") + ',"stoch_d":' + str.tostring(stoch_d, "#.#") + ',"ob_bars":' + str.tostring(ob_bars) + ',"os_bars":' + str.tostring(os_bars) + ',"div_quality":' + str.tostring(div_qual) + ',"settings_mode":"' + settings_mode + '","rsi_length":' + str.tostring(rsi_length) + ',"stoch_length":' + str.tostring(stoch_length) + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
