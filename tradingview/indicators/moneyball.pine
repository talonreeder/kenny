// This Pine Scriptâ„¢ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© YELENA AI Trading Platform

//@version=6
indicator("YELENA v2: Moneyball - Momentum Oscillator", shorttitle="Moneyball", overlay=false, max_labels_count=500)

// ============================================================================
// MONEYBALL v2 â€” VOLUME-WEIGHTED MOMENTUM OSCILLATOR
// ============================================================================
// Measures momentum direction and strength on a -100 to +100 scale.
// Volume-weighted ROC amplifies signals when institutional volume confirms
// the move, and dampens signals during low-conviction periods.
//
// Core pipeline: ROC â†’ Volume Weighting â†’ EMA Smoothing â†’ Normalization
//
// v2 ENHANCEMENTS over v1:
//   1. Auto-optimized ROC length and smoothing per symbol/timeframe
//   2. Volume-weighted momentum (high volume amplifies signals)
//   3. Divergence detection (price vs momentum divergence)
//   4. Momentum acceleration/deceleration tracking
//   5. Explosive momentum alerts (sudden large moves)
//   6. Zone classification (Strong Bear â†’ Strong Bull)
//   7. Info table with all real-time metrics
//   8. Hidden plot exports for Master Confluence
//   9. Enhanced webhook payload
// ============================================================================

// ==================== AUTO-OPTIMIZATION ENGINE ====================
tf_seconds = timeframe.in_seconds(timeframe.period)
string tf_group = tf_seconds <= 60 ? "scalp" : tf_seconds <= 900 ? "intraday" : "swing"

// Settings mode
string settings_mode = input.string("Auto", "Settings Mode", options=["Auto", "Manual"], group="âš™ï¸ Settings Mode", tooltip="Auto = optimal settings per symbol/timeframe.")

// Manual override inputs
int manual_roc_length = input.int(10, "ROC Length", minval=3, maxval=30, group="ðŸ”§ Manual Settings")
int manual_smooth_length = input.int(3, "Smoothing", minval=1, maxval=10, group="ðŸ”§ Manual Settings")

// Visual settings
bool show_flip_labels = input.bool(true, "Show Flip Labels", group="ðŸŽ¨ Visuals")
bool show_explosive_labels = input.bool(true, "Show Explosive Move Labels", group="ðŸŽ¨ Visuals")
bool show_divergence_labels = input.bool(true, "Show Divergence Labels", group="ðŸŽ¨ Visuals")
bool show_zone_bg = input.bool(true, "Show Zone Background", group="ðŸŽ¨ Visuals")
string table_position = input.string("Top Right", "Info Table Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group="ðŸŽ¨ Visuals")

// Divergence settings
int pivot_lookback = input.int(5, "Pivot Lookback", minval=3, maxval=15, group="ðŸ“ Divergence")
int div_lookback = input.int(30, "Divergence Max Lookback", minval=10, maxval=60, group="ðŸ“ Divergence")

// Alert settings
string passphrase = input.string("", "Webhook Passphrase", group="ðŸ”” Alerts")

// ==================== AUTO-OPTIMIZATION LOOKUP TABLES ====================
// Generated by optimize_params.py â€” REAL optimized values from backtesting
// Placeholder values will be replaced after running: python -m scripts.optimize_params --indicator moneyball

f_auto_roc_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 12 : 20
    else if t == "QQQ"
        tf_group == "scalp" ? 14 : tf_group == "intraday" ? 20 : 14
    else if t == "TSLA"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 12
    else if t == "NVDA"
        tf_group == "scalp" ? 14 : tf_group == "intraday" ? 20 : 16
    else if t == "META"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 14
    else if t == "NFLX"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 14 : 20
    else if t == "AAPL"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 16 : 14
    else if t == "GOOGL"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 16 : 20
    else if t == "MSFT"
        tf_group == "scalp" ? 16 : tf_group == "intraday" ? 20 : 16
    else if t == "AMZN"
        tf_group == "scalp" ? 12 : tf_group == "intraday" ? 20 : 16
    else if t == "AMD"
        tf_group == "scalp" ? 20 : tf_group == "intraday" ? 20 : 20
    else
        tf_group == "scalp" ? 10 : tf_group == "intraday" ? 10 : 12

f_auto_smooth_length() =>
    string t = syminfo.ticker
    if t == "SPY"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "QQQ"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "TSLA"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "NVDA"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "META"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "NFLX"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AAPL"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "GOOGL"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "MSFT"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AMZN"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else if t == "AMD"
        tf_group == "scalp" ? 8 : tf_group == "intraday" ? 8 : 8
    else
        tf_group == "scalp" ? 3 : tf_group == "intraday" ? 3 : 3

// Apply settings
int roc_length = settings_mode == "Auto" ? f_auto_roc_length() : manual_roc_length
int smooth_length = settings_mode == "Auto" ? f_auto_smooth_length() : manual_smooth_length

// Fixed parameters
int norm_length = 50
float extreme_threshold = 70.0

// ==================== CORE CALCULATIONS ====================

// --- Step 1: Rate of Change ---
float roc = close[roc_length] != 0 ? (close - close[roc_length]) / close[roc_length] * 100.0 : 0.0

// --- Step 2: Volume Weighting ---
float vol_sma = ta.sma(volume, roc_length)
float vol_ratio = vol_sma > 0 ? volume / vol_sma : 1.0
float vol_weight = math.max(0.5, math.min(2.0, vol_ratio))
float weighted_roc = roc * vol_weight

// --- Step 3: EMA Smoothing ---
float smoothed = ta.ema(weighted_roc, smooth_length)

// --- Step 4: Normalization to -100/+100 ---
float highest_smooth = ta.highest(smoothed, norm_length)
float lowest_smooth = ta.lowest(smoothed, norm_length)
float highest_abs = math.max(math.abs(highest_smooth), math.abs(lowest_smooth))
float moneyball = highest_abs > 0 ? (smoothed / highest_abs) * 100.0 : 0.0
moneyball := math.max(-100.0, math.min(100.0, moneyball))

// ==================== SIGNAL DETECTION ====================

// --- Zero-line flips ---
bool flipped_bullish = moneyball > 0 and moneyball[1] <= 0
bool flipped_bearish = moneyball < 0 and moneyball[1] >= 0

// --- Zone classification ---
// 1=Strong Bear, 2=Bear, 3=Neutral, 4=Bull, 5=Strong Bull
int zone = moneyball > extreme_threshold ? 5 : moneyball > 30 ? 4 : moneyball > -30 ? 3 : moneyball > -extreme_threshold ? 2 : 1
string zone_name = switch zone
    5 => "STRONG BULL"
    4 => "BULL"
    3 => "NEUTRAL"
    2 => "BEAR"
    1 => "STRONG BEAR"
    => "NEUTRAL"

// Zone entry signals
bool entered_strong_bull = zone == 5 and zone[1] != 5
bool entered_strong_bear = zone == 1 and zone[1] != 1

// Bars in current zone
var int bars_in_zone = 0
if zone != zone[1]
    bars_in_zone := 1
else
    bars_in_zone += 1

// --- Momentum slope (3-bar rate of change) ---
float slope = moneyball - nz(moneyball[3])
string slope_state = slope > 5 ? "ACCEL" : slope < -5 ? "DECEL" : "FLAT"

// --- Explosive move detection ---
float bar_change = math.abs(moneyball - nz(moneyball[1]))
float avg_change = ta.sma(math.abs(moneyball - nz(moneyball[1])), 20)
bool explosive = bar_change > avg_change * 3.0 and avg_change > 0

// --- Divergence detection ---
// Pivot highs and lows on Moneyball
float mb_pivot_high = ta.pivothigh(moneyball, pivot_lookback, pivot_lookback)
float mb_pivot_low = ta.pivotlow(moneyball, pivot_lookback, pivot_lookback)

// Pivot highs and lows on price
float price_pivot_high = ta.pivothigh(high, pivot_lookback, pivot_lookback)
float price_pivot_low = ta.pivotlow(low, pivot_lookback, pivot_lookback)

// Track previous pivots for comparison
var float prev_mb_high = na
var float prev_price_high = na
var int prev_high_bar = na
var float prev_mb_low = na
var float prev_price_low = na
var int prev_low_bar = na

// Bearish divergence: price higher high + MB lower high
bool bearish_div = false
if not na(mb_pivot_high)
    if not na(prev_mb_high) and not na(prev_price_high)
        if bar_index - nz(prev_high_bar) <= div_lookback
            if price_pivot_high > prev_price_high and mb_pivot_high < prev_mb_high
                bearish_div := true
    prev_mb_high := mb_pivot_high
    prev_price_high := price_pivot_high
    prev_high_bar := bar_index

// Bullish divergence: price lower low + MB higher low
bool bullish_div = false
if not na(mb_pivot_low)
    if not na(prev_mb_low) and not na(prev_price_low)
        if bar_index - nz(prev_low_bar) <= div_lookback
            if price_pivot_low < prev_price_low and mb_pivot_low > prev_mb_low
                bullish_div := true
    prev_mb_low := mb_pivot_low
    prev_price_low := price_pivot_low
    prev_low_bar := bar_index

// ==================== VISUAL RENDERING ====================

// --- Zone colors ---
color line_color = switch zone
    5 => color.new(#00E676, 0)   // Strong bull â€” bright green
    4 => color.new(#4CAF50, 0)   // Bull â€” green
    3 => color.new(#9E9E9E, 0)   // Neutral â€” gray
    2 => color.new(#F44336, 0)   // Bear â€” red
    1 => color.new(#D50000, 0)   // Strong bear â€” bright red
    => color.gray

// --- Main plot ---
plot(moneyball, "Moneyball", color=line_color, linewidth=2)

// --- Reference lines ---
hline(0, "Zero Line", color=color.new(color.white, 60), linestyle=hline.style_dashed)
hline(30, "+30", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(-30, "-30", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(70, "+70", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(-70, "-70", color=color.new(color.gray, 80), linestyle=hline.style_dotted)

// --- Zone background ---
bgcolor(show_zone_bg and zone == 5 ? color.new(#00E676, 92) : show_zone_bg and zone == 1 ? color.new(#D50000, 92) : na, title="Zone Background")

// --- Flip labels ---
if show_flip_labels and flipped_bullish
    label.new(bar_index, moneyball, "â–² BULL", style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white, size=size.small)

if show_flip_labels and flipped_bearish
    label.new(bar_index, moneyball, "â–¼ BEAR", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small)

// --- Explosive move labels ---
if show_explosive_labels and explosive
    color exp_color = moneyball > nz(moneyball[1]) ? color.lime : color.orange
    label.new(bar_index, moneyball, "âš¡", style=moneyball > nz(moneyball[1]) ? label.style_label_up : label.style_label_down, color=exp_color, textcolor=color.black, size=size.tiny)

// --- Divergence labels ---
if show_divergence_labels and bearish_div
    label.new(bar_index - pivot_lookback, moneyball[pivot_lookback], "DIV â–¼", style=label.style_label_down, color=color.new(#FF5722, 20), textcolor=color.white, size=size.tiny)

if show_divergence_labels and bullish_div
    label.new(bar_index - pivot_lookback, moneyball[pivot_lookback], "DIV â–²", style=label.style_label_up, color=color.new(#4CAF50, 20), textcolor=color.white, size=size.tiny)

// ==================== INFO TABLE ====================
string tbl_pos = switch table_position
    "Top Right" => position.top_right
    "Top Left" => position.top_left
    "Bottom Right" => position.bottom_right
    "Bottom Left" => position.bottom_left
    => position.top_right

var table info_table = table.new(tbl_pos, 2, 8, bgcolor=color.new(color.black, 80), border_width=1)

if barstate.islast
    // Row 0: Name
    table.cell(info_table, 0, 0, "Moneyball v2", text_color=color.white, text_size=size.small)
    table.cell(info_table, 1, 0, "", text_color=color.white, text_size=size.small)

    // Row 1: Score
    table.cell(info_table, 0, 1, "Score", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 1, str.tostring(moneyball, "#.0"), text_color=line_color, text_size=size.small)

    // Row 2: Zone
    table.cell(info_table, 0, 2, "Zone", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 2, zone_name, text_color=line_color, text_size=size.small)

    // Row 3: Slope
    table.cell(info_table, 0, 3, "Slope", text_color=color.gray, text_size=size.tiny)
    color slope_color = slope_state == "ACCEL" ? color.green : slope_state == "DECEL" ? color.red : color.gray
    table.cell(info_table, 1, 3, slope_state, text_color=slope_color, text_size=size.small)

    // Row 4: Volume Weight
    table.cell(info_table, 0, 4, "Vol Wt", text_color=color.gray, text_size=size.tiny)
    color vw_color = vol_weight > 1.3 ? color.green : vol_weight < 0.7 ? color.orange : color.white
    table.cell(info_table, 1, 4, str.tostring(vol_weight, "#.##") + "x", text_color=vw_color, text_size=size.small)

    // Row 5: Bars in zone
    table.cell(info_table, 0, 5, "Bars", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 5, str.tostring(bars_in_zone), text_color=color.white, text_size=size.small)

    // Row 6: Settings
    table.cell(info_table, 0, 6, "Settings", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 6, settings_mode == "Auto" ? "Auto" : "Manual", text_color=settings_mode == "Auto" ? color.lime : color.orange, text_size=size.tiny)

    // Row 7: Params
    table.cell(info_table, 0, 7, "Params", text_color=color.gray, text_size=size.tiny)
    table.cell(info_table, 1, 7, "ROC:" + str.tostring(roc_length) + " Sm:" + str.tostring(smooth_length), text_color=color.gray, text_size=size.tiny)

// ==================== HIDDEN PLOT EXPORTS ====================
plot(moneyball, "X_Moneyball", display=display.none)
plot(zone, "X_MoneyballZone", display=display.none)
plot(flipped_bullish ? 1 : flipped_bearish ? -1 : 0, "X_MoneyballFlip", display=display.none)
plot(explosive ? (moneyball > nz(moneyball[1]) ? 1 : -1) : 0, "X_MoneyballExplosive", display=display.none)
plot(slope, "X_MoneyballSlope", display=display.none)
plot(vol_weight, "X_MoneyballVolWeight", display=display.none)

// ==================== ALERTS ====================
alertcondition(flipped_bullish, "Moneyball: Flip Bullish", "Moneyball crossed above zero â€” momentum turning bullish")
alertcondition(flipped_bearish, "Moneyball: Flip Bearish", "Moneyball crossed below zero â€” momentum turning bearish")
alertcondition(entered_strong_bull, "Moneyball: Strong Bull Zone", "Moneyball entered Strong Bull zone (>+70) â€” extreme bullish momentum")
alertcondition(entered_strong_bear, "Moneyball: Strong Bear Zone", "Moneyball entered Strong Bear zone (<-70) â€” extreme bearish momentum")
alertcondition(explosive, "Moneyball: Explosive Move", "Moneyball explosive momentum detected â€” unusually large momentum shift")
alertcondition(bearish_div, "Moneyball: Bearish Divergence", "Bearish divergence â€” price making higher highs but momentum weakening")
alertcondition(bullish_div, "Moneyball: Bullish Divergence", "Bullish divergence â€” price making lower lows but momentum strengthening")

// ==================== WEBHOOK ALERT ====================
bool any_alert = flipped_bullish or flipped_bearish or entered_strong_bull or entered_strong_bear or explosive or bearish_div or bullish_div

if any_alert
    string alert_type = flipped_bullish ? "flip_bull" : flipped_bearish ? "flip_bear" : entered_strong_bull ? "strong_bull" : entered_strong_bear ? "strong_bear" : explosive ? "explosive" : bearish_div ? "div_bear" : "div_bull"
    string alert_msg = '{"passphrase":"' + passphrase + '","ticker":"' + syminfo.ticker + '","timeframe":"' + timeframe.period + '","indicator":"moneyball","alert_type":"' + alert_type + '","score":' + str.tostring(moneyball, "#.#") + ',"zone":"' + zone_name + '","slope":"' + slope_state + '","vol_weight":' + str.tostring(vol_weight, "#.##") + ',"bars_in_zone":' + str.tostring(bars_in_zone) + ',"settings_mode":"' + settings_mode + '","roc_length":' + str.tostring(roc_length) + ',"smooth_length":' + str.tostring(smooth_length) + ',"timestamp":"' + str.format_time(timenow, "yyyy-MM-dd'T'HH:mm:ss'Z'", "UTC") + '"}'
    alert(alert_msg, alert.freq_once_per_bar_close)
